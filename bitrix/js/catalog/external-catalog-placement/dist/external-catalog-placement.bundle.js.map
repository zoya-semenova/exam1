{"version":3,"file":"external-catalog-placement.bundle.js","sources":["../src/external-catalog-placement.js"],"sourcesContent":["import { Tag, Dom, ajax, Runtime, Extension } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nexport class ExternalCatalogPlacement\n{\n\tstatic #instance: ExternalCatalogPlacement = null;\n\tstatic #CODE: string = 'CATALOG_EXTERNAL_PRODUCT';\n\t#appSid: ?string = null;\n\t#initializePromise = null;\n\t#isInitialized: boolean = false;\n\t#initializationError: Error = null;\n\n\tstatic LOAD_PLACEMENT_ERROR: string = 'LOAD_PLACEMENT_ERROR';\n\tstatic REGISTER_PLACEMENT_ERROR: string = 'REGISTER_PLACEMENT_ERROR';\n\tstatic LOAD_PLACEMENT_LAYOUT_ERROR: string = 'LOAD_PLACEMENT_LAYOUT_ERROR';\n\n\tstatic RESPONSE_TIMEOUT = 20000;\n\n\tstatic create(): ExternalCatalogPlacement\n\t{\n\t\tif (this.#instance)\n\t\t{\n\t\t\treturn this.#instance;\n\t\t}\n\n\t\tthis.#instance = new this();\n\n\t\treturn this.#instance;\n\t}\n\n\tinitialize(): Promise\n\t{\n\t\tif (!this.#initializePromise)\n\t\t{\n\t\t\tthis.#initializePromise = new Promise((resolve, reject) => {\n\t\t\t\tthis\n\t\t\t\t\t.#loadPlacement()\n\t\t\t\t\t.then((response) => this.#registerPlacement(response))\n\t\t\t\t\t.then((data) => this.#loadPlacementLayout(data))\n\t\t\t\t\t.then((response) => this.#runPlacementLayout(response))\n\t\t\t\t\t.then(() => this.#waitForOnReadyEvent())\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tthis.#isInitialized = true;\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tthis.#isInitialized = true;\n\t\t\t\t\t\tthis.#initializationError = error;\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\treturn this.#initializePromise;\n\t}\n\n\treset(): void\n\t{\n\t\tthis.#initializePromise = null;\n\t}\n\n\t#loadPlacement(): Promise\n\t{\n\t\tif (Extension.getSettings('catalog.external-catalog-placement').get('is1cPlanRestricted', false))\n\t\t{\n\t\t\treturn Promise.reject({\n\t\t\t\treason: 'tariff',\n\t\t\t});\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tajax.runComponentAction(\n\t\t\t\t'bitrix:app.placement',\n\t\t\t\t'getComponent',\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tplacementId: ExternalCatalogPlacement.#CODE,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t)\n\t\t\t\t.then((response) => resolve(response))\n\t\t\t\t.catch(() => reject(\n\t\t\t\t\tnew Error(\n\t\t\t\t\t\tExternalCatalogPlacement.LOAD_PLACEMENT_ERROR,\n\t\t\t\t\t\t{ cause: ExternalCatalogPlacement.LOAD_PLACEMENT_ERROR },\n\t\t\t\t\t),\n\t\t\t\t))\n\t\t\t;\n\t\t});\n\t}\n\n\t#registerPlacement(response: Object): Promise\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst node = Tag.render`<div style=\"display: none; overflow: hidden;\"></div>`;\n\t\t\tDom.append(node, document.body);\n\t\t\tRuntime.html(\n\t\t\t\tnode,\n\t\t\t\tresponse.data.html,\n\t\t\t\t{\n\t\t\t\t\tcallback: () => setTimeout(() => {\n\t\t\t\t\t\tconst appLayout = BX.Reflection.getClass('BX.rest.AppLayout');\n\t\t\t\t\t\tconst placement = appLayout ? appLayout.getPlacement(ExternalCatalogPlacement.#CODE) : null;\n\n\t\t\t\t\t\tif (placement)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\t\tplacement,\n\t\t\t\t\t\t\t\tplacementInterface: BX.rest.AppLayout.initializePlacement(ExternalCatalogPlacement.#CODE),\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treject(\n\t\t\t\t\t\t\tnew Error(\n\t\t\t\t\t\t\t\tExternalCatalogPlacement.REGISTER_PLACEMENT_ERROR,\n\t\t\t\t\t\t\t\t{ cause: ExternalCatalogPlacement.REGISTER_PLACEMENT_ERROR },\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t);\n\t\t\t\t\t}, 10),\n\t\t\t\t},\n\t\t\t);\n\t\t});\n\t}\n\n\t#loadPlacementLayout(data: Object): Promise\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tdata.placementInterface.prototype.onReady = (eventData) => {\n\t\t\t\tEventEmitter.emit('Catalog:ProductSelectorPlacement:onReady', eventData);\n\t\t\t};\n\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tdata.placementInterface.prototype.onProductCreated = (eventData) => {\n\t\t\t\tEventEmitter.emit('Catalog:ProductSelectorPlacement:onProductCreated', eventData);\n\t\t\t};\n\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tdata.placementInterface.prototype.onProductUpdated = (eventData) => {\n\t\t\t\tEventEmitter.emit('Catalog:ProductSelectorPlacement:onProductUpdated', eventData);\n\t\t\t};\n\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tdata.placementInterface.prototype.onProductsFound = (eventData) => {\n\t\t\t\tEventEmitter.emit('Catalog:ProductSelectorPlacement:onProductsFound', eventData);\n\t\t\t};\n\n\t\t\tdata.placementInterface.prototype.events.push(\n\t\t\t\t'Catalog:ProductSelectorPlacement:onNeedProductCreate',\n\t\t\t\t'Catalog:ProductSelectorPlacement:onNeedProductUpdate',\n\t\t\t\t'Catalog:ProductSelectorPlacement:onNeedSearchProducts',\n\t\t\t);\n\n\t\t\tajax.runComponentAction(\n\t\t\t\t'bitrix:app.layout',\n\t\t\t\t'getComponent',\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tplacementId: data.placement.param.current,\n\t\t\t\t\t\tplacementOptions: null,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t)\n\t\t\t\t.then((response) => {\n\t\t\t\t\tresolve(response);\n\t\t\t\t})\n\t\t\t\t.catch(() => {\n\t\t\t\t\tconsole.error('#loadPlacementLayout err');\n\t\t\t\t\treject(\n\t\t\t\t\t\tnew Error(\n\t\t\t\t\t\t\tExternalCatalogPlacement.LOAD_PLACEMENT_LAYOUT_ERROR,\n\t\t\t\t\t\t\t{ cause: ExternalCatalogPlacement.LOAD_PLACEMENT_LAYOUT_ERROR },\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t});\n\t}\n\n\t#runPlacementLayout(response: Object): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tthis.#appSid = response.data.componentResult.APP_SID;\n\n\t\t\tconst iframeNode = Tag.render`\n\t\t\t\t<div\n\t\t\t\t\tdata-app-sid=\"${this.#appSid}\"\n\t\t\t\t\tstyle=\"display: none; overflow: hidden\"\n\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t\tDom.append(iframeNode, document.body);\n\t\t\tRuntime.html(iframeNode, response.data.html);\n\n\t\t\tresolve();\n\t\t});\n\t}\n\n\t#waitForOnReadyEvent(): Promise\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tEventEmitter.subscribe(\n\t\t\t\t'Catalog:ProductSelectorPlacement:onReady',\n\t\t\t\t() => {\n\t\t\t\t\tresolve();\n\t\t\t\t},\n\t\t\t);\n\t\t\tsetTimeout(() => reject(), ExternalCatalogPlacement.RESPONSE_TIMEOUT);\n\t\t});\n\t}\n\n\tgetAppSidId(): ?string\n\t{\n\t\treturn this.#appSid;\n\t}\n\n\tisInitialized(): boolean\n\t{\n\t\treturn this.#isInitialized;\n\t}\n\n\tisInitializedSuccessfully(): boolean\n\t{\n\t\treturn this.#isInitialized && this.getInitializationError() === null;\n\t}\n\n\tgetInitializationError(): ?Error\n\t{\n\t\treturn this.#initializationError;\n\t}\n}\n"],"names":["ExternalCatalogPlacement","create","initialize","Promise","resolve","reject","then","response","data","catch","error","reset","getAppSidId","isInitialized","isInitializedSuccessfully","getInitializationError","Extension","getSettings","get","reason","ajax","runComponentAction","placementId","Error","LOAD_PLACEMENT_ERROR","cause","node","Tag","render","Dom","append","document","body","Runtime","html","callback","setTimeout","appLayout","BX","Reflection","getClass","placement","getPlacement","placementInterface","rest","AppLayout","initializePlacement","REGISTER_PLACEMENT_ERROR","prototype","onReady","eventData","EventEmitter","emit","onProductCreated","onProductUpdated","onProductsFound","events","push","param","current","placementOptions","console","LOAD_PLACEMENT_LAYOUT_ERROR","componentResult","APP_SID","iframeNode","subscribe","RESPONSE_TIMEOUT"],"mappings":"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"}