this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Provider=this.BX.Messenger.v2.Provider||{};(function(e,s,a,t,r,i,l,o,d,c,n,b,h,p,v,g,u,P,F){"use strict";var L=babelHelpers.classPrivateFieldLooseKey("restResult");var H=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var f=babelHelpers.classPrivateFieldLooseKey("users");var m=babelHelpers.classPrivateFieldLooseKey("chats");var B=babelHelpers.classPrivateFieldLooseKey("messages");var y=babelHelpers.classPrivateFieldLooseKey("files");var I=babelHelpers.classPrivateFieldLooseKey("recentItems");var M=babelHelpers.classPrivateFieldLooseKey("extractUser");var C=babelHelpers.classPrivateFieldLooseKey("extractChat");var S=babelHelpers.classPrivateFieldLooseKey("extractMessage");var w=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var O=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var U=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var j=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var R=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var E=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");var K=babelHelpers.classPrivateFieldLooseKey("mergeFileIds");class T{constructor(e){Object.defineProperty(this,K,{value:$});Object.defineProperty(this,E,{value:G});Object.defineProperty(this,R,{value:X});Object.defineProperty(this,j,{value:V});Object.defineProperty(this,U,{value:N});Object.defineProperty(this,O,{value:k});Object.defineProperty(this,w,{value:_});Object.defineProperty(this,S,{value:x});Object.defineProperty(this,C,{value:A});Object.defineProperty(this,M,{value:D});Object.defineProperty(this,L,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:void 0});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,m,{writable:true,value:{}});Object.defineProperty(this,B,{writable:true,value:{}});Object.defineProperty(this,y,{writable:true,value:{}});Object.defineProperty(this,I,{writable:true,value:{}});const{rawData:s,withBirthdays:a=true}=e;babelHelpers.classPrivateFieldLooseBase(this,H)[H]=a;babelHelpers.classPrivateFieldLooseBase(this,L)[L]=s}getItems(){const{items:e=[],copilot:s}=babelHelpers.classPrivateFieldLooseBase(this,L)[L];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,M)[M](e);babelHelpers.classPrivateFieldLooseBase(this,C)[C](e);babelHelpers.classPrivateFieldLooseBase(this,S)[S](e);babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)}));babelHelpers.classPrivateFieldLooseBase(this,O)[O]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,f)[f]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,m)[m]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,B)[B]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,y)[y]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,I)[I]),copilot:s}}}function D(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,f)[f][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,f)[f][e.user.id]=e.user}}function A(e){if(e.chat){babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]=babelHelpers.classPrivateFieldLooseBase(this,U)[U](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,R)[R](e.user)}}else if(e.user.id){const s=u.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,j)[j](e)}}}function x(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${F.FakeMessagePrefix}-${e.id}`}let a=false;if(s.status===F.MessageStatus.delivered){a=true}const t=u.Core.getStore().getters["messages/getById"](s.id);if(d.Type.isArrayFilled(t==null?void 0:t.attach)){delete s.attach}if(d.Type.isPlainObject(s.file)){const e=s.file;if(t){s.files=babelHelpers.classPrivateFieldLooseBase(this,K)[K](t,e.id)}else{s.files=[e.id]}const a=u.Core.getStore().getters["files/get"](e.id);if(!a){babelHelpers.classPrivateFieldLooseBase(this,y)[y][e.id]=e}}babelHelpers.classPrivateFieldLooseBase(this,B)[B][s.id]={...s,viewedByOthers:a}}function _(e){var s,a;const t=(s=(a=e.message)==null?void 0:a.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.id]={...e,messageId:t}}function k(){if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,L)[L];e.forEach((e=>{if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f][e.id]){babelHelpers.classPrivateFieldLooseBase(this,f)[f][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]){babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.id]=babelHelpers.classPrivateFieldLooseBase(this,R)[R](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.id]){const s=`${F.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,E)[E](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,B)[B][s]={id:s}}}))}function N(e){return{...e.chat,counter:e.counter,dialogId:e.id,copilot:e.copilot}}function V(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:F.ChatType.user,counter:e.counter,role:F.UserRole.member}}function X(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:F.ChatType.user,role:F.UserRole.member}}function G(e){return{id:e.id,isBirthdayPlaceholder:true}}function $(e,s){const a=e.files.map((e=>Number.parseInt(e,10)));const t=new Set([...a,s]);return[...t]}class W{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return u.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){v.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const s=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return s}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){v.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:s,hasMore:a}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!a){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;this.updateModels(e)}hideChat(e){v.Logger.warn("Im.RecentList: hide chat",e);const s=u.Core.getStore().getters["recent/get"](e);if(!s){return}u.Core.getStore().dispatch("recent/delete",{id:e});const a=u.Core.getStore().getters["application/isChatOpen"](e);if(a){r.Messenger.openChat()}u.Core.getRestClient().callMethod(F.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e)}))}async requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);const a=await u.Core.getRestClient().callMethod(this.getQueryMethod(),s).catch((e=>{console.error("Im.RecentList: page request error",e)}));this.pagesLoaded++;v.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,a.data());const{items:t,hasMore:r}=a.data();this.lastMessageDate=this.getLastMessageDate(t);if(!r){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(a.data())}getQueryMethod(){return F.RestMethod.imRecentList}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const s=new T({rawData:e,...this.getExtractorOptions()});const a=s.getItems();const{users:t,chats:r,messages:l,files:o,recentItems:d,copilot:c}=a;v.Logger.warn("RecentService: prepared data for models",a);const n=u.Core.getStore().dispatch("users/set",t);const b=u.Core.getStore().dispatch("chats/set",r);const h=u.Core.getStore().dispatch("messages/store",l);const p=u.Core.getStore().dispatch("files/set",o);const g=u.Core.getStore().dispatch(this.getModelSaveMethod(),d);const P=new i.CopilotManager;const F=P.handleRecentListResponse(c);return Promise.all([n,b,h,p,g,F])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}W.instance=null;var q=babelHelpers.classPrivateFieldLooseKey("restResult");class z{constructor(e){Object.defineProperty(this,q,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,q)[q]=e}getChatId(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat.id}getDialogId(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat.dialogId}isOpenlinesChat(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat.type===F.ChatType.lines}isCopilotChat(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat.type===F.ChatType.copilot}getChats(){const e={...babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat,hasPrevPage:babelHelpers.classPrivateFieldLooseBase(this,q)[q].hasPrevPage,hasNextPage:babelHelpers.classPrivateFieldLooseBase(this,q)[q].hasNextPage};const s={[babelHelpers.classPrivateFieldLooseBase(this,q)[q].chat.dialogId]:e};babelHelpers.classPrivateFieldLooseBase(this,q)[q].users.forEach((e=>{if(s[e.id]){s[e.id]={...s[e.id],...c.UserManager.getDialogForUser(e)}}else{s[e.id]=c.UserManager.getDialogForUser(e)}}));return Object.values(s)}getFiles(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].files)!=null?e:[]}getUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].users)!=null?e:[]}getAdditionalUsers(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].usersShort)!=null?e:[]}getMessages(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].messages)!=null?e:[]}getCommentInfo(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].commentInfo)!=null?e:[]}getMessagesToStore(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].additionalMessages)!=null?e:[]}getPinnedMessageIds(){var e;const s=[];const a=(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].pins)!=null?e:[];a.forEach((e=>{s.push(e.messageId)}));return s}getReactions(){var e;return(e=babelHelpers.classPrivateFieldLooseBase(this,q)[q].reactions)!=null?e:[]}getCopilot(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q].copilot}}var Y=babelHelpers.classPrivateFieldLooseKey("store");var Q=babelHelpers.classPrivateFieldLooseKey("requestChat");var J=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoading");var Z=babelHelpers.classPrivateFieldLooseKey("markDialogAsLoaded");var ee=babelHelpers.classPrivateFieldLooseKey("markDialogAsNotLoaded");var se=babelHelpers.classPrivateFieldLooseKey("isDialogLoadedMarkNeeded");var ae=babelHelpers.classPrivateFieldLooseKey("updateModels");var te=babelHelpers.classPrivateFieldLooseKey("needLayoutRedirect");var re=babelHelpers.classPrivateFieldLooseKey("redirectToLayout");var ie=babelHelpers.classPrivateFieldLooseKey("needRedirectToCopilotLayout");var le=babelHelpers.classPrivateFieldLooseKey("needRedirectToOpenLinesLayout");class oe{constructor(){Object.defineProperty(this,le,{value:Pe});Object.defineProperty(this,ie,{value:ue});Object.defineProperty(this,re,{value:ge});Object.defineProperty(this,te,{value:ve});Object.defineProperty(this,ae,{value:pe});Object.defineProperty(this,se,{value:he});Object.defineProperty(this,ee,{value:be});Object.defineProperty(this,Z,{value:ne});Object.defineProperty(this,J,{value:ce});Object.defineProperty(this,Q,{value:de});Object.defineProperty(this,Y,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=u.Core.getStore()}loadChat(e){const s={dialogId:e};return babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](F.RestMethod.imV2ChatShallowLoad,s)}loadChatWithMessages(e){const a={dialogId:e,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](F.RestMethod.imV2ChatLoad,a)}loadChatWithContext(e,a){const t={dialogId:e,messageId:a,messageLimit:s.MessageService.getMessageRequestLimit()};return babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](F.RestMethod.imV2ChatLoadInContext,t)}prepareDialogId(e){if(!b.Utils.dialog.isExternalId(e)){return Promise.resolve(e)}return P.runAction(F.RestMethod.imV2ChatGetDialogId,{data:{externalId:e}}).then((e=>e.dialogId)).catch((e=>{console.error("ChatService: Load: error preparing external id",e)}))}async loadComments(e){const a={postId:e,messageLimit:s.MessageService.getMessageRequestLimit(),autoJoin:true,createIfNotExists:true};const{chatId:t}=await babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](F.RestMethod.imV2ChatLoad,a);return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/comments/set",{messageId:e,chatId:t})}async loadCommentInfo(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].getters["chats/get"](e,true);const a=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].getters["messages/getByChatId"](s.chatId);const t=a.map((e=>e.id));const{commentInfo:r,usersShort:i}=await P.runAction(F.RestMethod.imV2ChatMessageCommentInfoList,{data:{messageIds:t}}).catch((e=>{console.error("ChatService: Load: error loading comment info",e)}));const l=new c.UserManager;void babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/comments/set",r);void l.addUsersToModel(i)}resetChat(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].getters["chats/get"](e,true);babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/clearChatCollection",{chatId:s.chatId});babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("chats/update",{dialogId:e,fields:{inited:false}})}}async function de(e,s){const{dialogId:a,messageId:t}=s;babelHelpers.classPrivateFieldLooseBase(this,J)[J](a);const r=await P.runAction(e,{data:s}).catch((e=>{console.error("ChatService: Load: error loading chat",e);babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](a);throw e}));if(babelHelpers.classPrivateFieldLooseBase(this,te)[te](r)){return babelHelpers.classPrivateFieldLooseBase(this,re)[re](r,t)}const{dialogId:i,chatId:l}=await babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](r);if(babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)){await babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](i)}return{dialogId:i,chatId:l}}function ce(e){void babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("chats/update",{dialogId:e,fields:{loading:true}})}function ne(e){return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("chats/update",{dialogId:e,fields:{inited:true,loading:false}})}function be(e){return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("chats/update",{dialogId:e,fields:{loading:false}})}function he(e){return e!==F.RestMethod.imV2ChatShallowLoad}async function pe(e){const s=new z(e);const a=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("chats/set",s.getChats());const t=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("files/set",s.getFiles());const r=new c.UserManager;const l=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("users/set",s.getUsers()),r.addUsersToModel(s.getAdditionalUsers())]);const o=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/setChatCollection",{messages:s.getMessages(),clearCollection:true}),babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/store",s.getMessagesToStore()),babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/pin/setPinned",{chatId:s.getChatId(),pinnedMessages:s.getPinnedMessageIds()}),babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/reactions/set",s.getReactions()),babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].dispatch("messages/comments/set",s.getCommentInfo())]);const d=new i.CopilotManager;const n=d.handleChatLoadResponse(s.getCopilot());await Promise.all([a,t,l,o,n]);return{dialogId:s.getDialogId(),chatId:s.getChatId()}}function ve(e){return babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e)||babelHelpers.classPrivateFieldLooseBase(this,le)[le](e)}function ge(e,s=0){const t=new z(e);a.LayoutManager.getInstance().setLastOpenedElement(F.Layout.chat.name,"");if(babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e)){return r.Messenger.openCopilot(t.getDialogId(),s)}if(babelHelpers.classPrivateFieldLooseBase(this,le)[le](e)){return r.Messenger.openLines(t.getDialogId())}return Promise.resolve()}function ue(e){const s=new z(e);const t=a.LayoutManager.getInstance().getLayout().name;return s.isCopilotChat()&&t!==F.Layout.copilot.name}function Pe(e){const s=new z(e);return s.isOpenlinesChat()&&d.Type.isStringFilled(s.getDialogId())}const Fe="CHAT";const Le="OPEN";var He=babelHelpers.classPrivateFieldLooseKey("restClient");var fe=babelHelpers.classPrivateFieldLooseKey("store");var me=babelHelpers.classPrivateFieldLooseKey("prepareFields");var Be=babelHelpers.classPrivateFieldLooseKey("addChatToModel");var ye=babelHelpers.classPrivateFieldLooseKey("sendAnalytics");class Ie{constructor(){Object.defineProperty(this,ye,{value:Se});Object.defineProperty(this,Be,{value:Ce});Object.defineProperty(this,me,{value:Me});Object.defineProperty(this,He,{writable:true,value:void 0});Object.defineProperty(this,fe,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,He)[He]=u.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=u.Core.getStore()}async createChat(e){v.Logger.warn("ChatService: createChat",e);const s=await babelHelpers.classPrivateFieldLooseBase(this,me)[me](e);const a=await babelHelpers.classPrivateFieldLooseBase(this,He)[He].callMethod(F.RestMethod.imV2ChatAdd,{fields:s}).catch((e=>{console.error("ChatService: createChat error:",e);throw new Error(e)}));const{chatId:t}=a.data();v.Logger.warn("ChatService: createChat result",t);const r=`chat${t}`;babelHelpers.classPrivateFieldLooseBase(this,Be)[Be](r,s);babelHelpers.classPrivateFieldLooseBase(this,ye)[ye](r);return{newDialogId:r,newChatId:t}}}async function Me(e){var s,a,t,r;const i={...e};if(i.avatar){i.avatar=await b.Utils.file.getBase64(e.avatar)}i.managers=(s=i.managers)!=null?s:[];i.members=(a=i.members)!=null?a:[];const l=[...i.members,...i.managers];if(i.ownerId){l.push(i.ownerId)}i.members=[...new Set(l)];const o={type:(t=i.type)==null?void 0:t.toUpperCase(),entityType:(r=i.entityType)==null?void 0:r.toUpperCase(),title:i.title,avatar:i.avatar,description:i.description,users:i.members,memberEntities:i.memberEntities,managers:i.managers,ownerId:i.ownerId,searchable:i.isAvailableInSearch?"Y":"N",manageUsersAdd:i.manageUsersAdd,manageUsersDelete:i.manageUsersDelete,manageUi:i.manageUi,manageSettings:i.manageSettings,manageMessages:i.manageMessages,conferencePassword:i.conferencePassword,copilotMainRole:i.copilotMainRole};Object.entries(o).forEach((([e,s])=>{if(d.Type.isUndefined(s)){delete o[e]}}));return o}function Ce(e,s){let a=s.searchable==="Y"?Le:Fe;if(d.Type.isStringFilled(s.entityType)){a=s.entityType.toLowerCase()}if(d.Type.isStringFilled(s.type)){a=s.type.toLowerCase()}babelHelpers.classPrivateFieldLooseBase(this,fe)[fe].dispatch("chats/set",{dialogId:e,type:a.toLowerCase(),name:s.title,userCounter:s.users.length,role:F.UserRole.owner,permissions:{manageUi:s.manageUi,manageSettings:s.manageSettings,manageUsersAdd:s.manageUsersAdd,manageUsersDelete:s.manageUsersDelete,manageMessages:s.manageMessages}})}function Se(e){g.Analytics.getInstance().onCreateChat(e)}class we{async prepareAvatar(e){if(!p.isResizableImage(e)){return Promise.reject(new Error("UpdateService: prepareAvatar: incorrect image"))}const s=180;const{preview:a}=await p.resizeImage(e,{width:s,height:s});return a}async changeAvatar(e,s){v.Logger.warn("ChatService: changeAvatar",e,s);const a=await b.Utils.file.getBase64(s);return P.runAction(F.RestMethod.imV2ChatUpdate,{data:{id:e,fields:{avatar:a}}}).catch((e=>{console.error("ChatService: changeAvatar error:",e);throw new Error(e)}))}}var Oe=babelHelpers.classPrivateFieldLooseKey("store");var Ue=babelHelpers.classPrivateFieldLooseKey("restClient");var je=babelHelpers.classPrivateFieldLooseKey("updateChatTitleInModel");class Re{constructor(){Object.defineProperty(this,je,{value:Ee});Object.defineProperty(this,Oe,{writable:true,value:void 0});Object.defineProperty(this,Ue,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue]=u.Core.getRestClient()}renameChat(e,s){v.Logger.warn("ChatService: renameChat",e,s);if(s===""){return Promise.resolve()}const a=babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe].getters["chats/get"](e);const t=a.name;babelHelpers.classPrivateFieldLooseBase(this,je)[je](e,s);return babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue].callMethod(F.RestMethod.imChatUpdateTitle,{dialog_id:e,title:s}).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,je)[je](e,t);throw new Error("Chat rename error")}))}}function Ee(e,s){babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe].dispatch("chats/update",{dialogId:e,fields:{name:s}})}var Ke=babelHelpers.classPrivateFieldLooseKey("store");var Te=babelHelpers.classPrivateFieldLooseKey("restClient");var De=babelHelpers.classPrivateFieldLooseKey("sendMuteRequestDebounced");var Ae=babelHelpers.classPrivateFieldLooseKey("sendMuteRequest");class xe{constructor(){Object.defineProperty(this,Ae,{value:_e});Object.defineProperty(this,Ke,{writable:true,value:void 0});Object.defineProperty(this,Te,{writable:true,value:void 0});Object.defineProperty(this,De,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Te)[Te]=u.Core.getRestClient();const e=500;babelHelpers.classPrivateFieldLooseBase(this,De)[De]=d.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae],e)}muteChat(e){v.Logger.warn("ChatService: muteChat",e);babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].dispatch("chats/mute",{dialogId:e});const s={dialog_id:e,action:"Y"};babelHelpers.classPrivateFieldLooseBase(this,De)[De](s)}unmuteChat(e){v.Logger.warn("ChatService: unmuteChat",e);babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].dispatch("chats/unmute",{dialogId:e});const s={dialog_id:e,action:"N"};babelHelpers.classPrivateFieldLooseBase(this,De)[De](s)}}function _e(e){const{dialog_id:s,action:a}=e;return babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].callMethod(F.RestMethod.imChatMute,e).catch((e=>{const t=a==="Y"?"muting":"unmuting";console.error(`Im.RecentList: error ${t} chat`,e);const r=a==="Y"?"chats/unmute":"chats/mute";babelHelpers.classPrivateFieldLooseBase(this,Ke)[Ke].dispatch(r,{dialogId:s})}))}var ke=babelHelpers.classPrivateFieldLooseKey("store");var Ne=babelHelpers.classPrivateFieldLooseKey("restClient");class Ve{constructor(){Object.defineProperty(this,ke,{writable:true,value:void 0});Object.defineProperty(this,Ne,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ke)[ke]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne]=u.Core.getRestClient()}pinChat(e){v.Logger.warn("PinService: pinChat",e);babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("recent/pin",{id:e,action:true});const s={DIALOG_ID:e,ACTION:"Y"};babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].callMethod(F.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error pinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("recent/pin",{id:e,action:false})}))}unpinChat(e){v.Logger.warn("PinService: unpinChat",e);babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("recent/pin",{id:e,action:false});const s={DIALOG_ID:e,ACTION:"N"};babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne].callMethod(F.RestMethod.imRecentPin,s).catch((s=>{console.error("PinService: error unpinning chat",s);babelHelpers.classPrivateFieldLooseBase(this,ke)[ke].dispatch("recent/pin",{id:e,action:true})}))}}const Xe=300;var Ge=babelHelpers.classPrivateFieldLooseKey("store");var $e=babelHelpers.classPrivateFieldLooseKey("restClient");var We=babelHelpers.classPrivateFieldLooseKey("messagesToRead");var qe=babelHelpers.classPrivateFieldLooseKey("readMessagesForChat");var ze=babelHelpers.classPrivateFieldLooseKey("readMessageOnClient");var Ye=babelHelpers.classPrivateFieldLooseKey("decreaseCommentCounter");var Qe=babelHelpers.classPrivateFieldLooseKey("decreaseChatCounter");var Je=babelHelpers.classPrivateFieldLooseKey("readMessageOnServer");var Ze=babelHelpers.classPrivateFieldLooseKey("checkChatCounter");var es=babelHelpers.classPrivateFieldLooseKey("getDialogIdByChatId");var ss=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");class as{constructor(){Object.defineProperty(this,ss,{value:ns});Object.defineProperty(this,es,{value:cs});Object.defineProperty(this,Ze,{value:ds});Object.defineProperty(this,Je,{value:os});Object.defineProperty(this,Qe,{value:ls});Object.defineProperty(this,Ye,{value:is});Object.defineProperty(this,ze,{value:rs});Object.defineProperty(this,qe,{value:ts});Object.defineProperty(this,Ge,{writable:true,value:void 0});Object.defineProperty(this,$e,{writable:true,value:void 0});Object.defineProperty(this,We,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,$e)[$e]=u.Core.getRestClient()}readAll(){v.Logger.warn("ReadService: readAll");babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/clearCounters");babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("recent/clearUnread");return babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].callMethod(F.RestMethod.imV2ChatReadAll).catch((e=>{console.error("ReadService: readAll error",e)}))}readDialog(e){v.Logger.warn("ReadService: readDialog",e);babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/update",{dialogId:e,fields:{counter:0}});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].callMethod(F.RestMethod.imV2ChatRead,{dialogId:e}).catch((e=>{console.error("ReadService: error reading chat",e)}))}unreadDialog(e){v.Logger.warn("ReadService: unreadDialog",e);babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("recent/unread",{id:e,action:true});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].callMethod(F.RestMethod.imV2ChatUnread,{dialogId:e}).catch((s=>{console.error("ReadService: error setting chat as unread",s);babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("recent/unread",{id:e,action:false})}))}readMessage(e,s){if(!babelHelpers.classPrivateFieldLooseBase(this,We)[We][e]){babelHelpers.classPrivateFieldLooseBase(this,We)[We][e]=new Set}babelHelpers.classPrivateFieldLooseBase(this,We)[We][e].add(s);clearTimeout(this.readTimeout);this.readTimeout=setTimeout((()=>{Object.entries(babelHelpers.classPrivateFieldLooseBase(this,We)[We]).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,qe)[qe](e,s)}))}),Xe)}clearDialogMark(e){v.Logger.warn("ReadService: clear dialog mark",e);const s=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].getters["chats/get"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].getters["recent/get"](e);if(s.markedId===0&&!(a!=null&&a.unread)){return}babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("recent/unread",{id:e,action:false});babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/update",{dialogId:e,fields:{markedId:0}});babelHelpers.classPrivateFieldLooseBase(this,$e)[$e].callMethod(F.RestMethod.imV2ChatRead,{dialogId:e,onlyRecent:"Y"}).catch((e=>{console.error("ReadService: error clearing dialog mark",e)}))}}async function ts(e,s){const a=Number.parseInt(e,10);v.Logger.warn("ReadService: readMessages",s);if(s.size===0){return}const t=[...s];delete babelHelpers.classPrivateFieldLooseBase(this,We)[We][a];const r=await babelHelpers.classPrivateFieldLooseBase(this,ze)[ze](a,t);v.Logger.warn("ReadService: readMessage, need to reduce counter by",r);await babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe](a,r);const i=await babelHelpers.classPrivateFieldLooseBase(this,Je)[Je](a,t).catch((e=>{console.error("ReadService: error reading message",e)}));babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze](i)}function rs(e,s){const a=Math.max(...s);const t=babelHelpers.classPrivateFieldLooseBase(this,ss)[ss](e);if(a>t.lastReadId){babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,es)[es](e),fields:{lastId:a}})}return babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("messages/readMessages",{chatId:e,messageIds:s})}function is(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ss)[ss](e);let t=a.counter-s;if(t<0){t=0}const r={[a.parentChatId]:{[e]:t}};return u.Core.getStore().dispatch("counters/setCommentCounters",r)}function ls(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ss)[ss](e);if(a.type===F.ChatType.comment){return babelHelpers.classPrivateFieldLooseBase(this,Ye)[Ye](e,s)}let t=a.counter-s;if(t<0){t=0}return babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,es)[es](e),fields:{counter:t}})}function os(e,s){v.Logger.warn("ReadService: readMessages on server",s);return P.runAction(F.RestMethod.imV2ChatMessageRead,{data:{chatId:e,ids:s,actionUuid:t.UuidManager.getInstance().getActionUuid()}})}function ds(e){const{chatId:s,counter:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,ss)[ss](s);if(t.counter>a){v.Logger.warn("ReadService: counter from server is lower than local one",t.counter,a);babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].dispatch("chats/update",{dialogId:t.dialogId,fields:{counter:a}})}}function cs(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].getters["chats/getByChatId"](e);if(!s){return 0}return s.dialogId}function ns(e){return babelHelpers.classPrivateFieldLooseBase(this,Ge)[Ge].getters["chats/getByChatId"](e)}const bs={userInvitedFromStructure:"USER_INVITED_FROM_STRUCTURE",userNotFound:"USER_NOT_FOUND"};var hs=babelHelpers.classPrivateFieldLooseKey("store");var ps=babelHelpers.classPrivateFieldLooseKey("restClient");var vs=babelHelpers.classPrivateFieldLooseKey("onChatLeave");var gs=babelHelpers.classPrivateFieldLooseKey("onChatKickError");var us=babelHelpers.classPrivateFieldLooseKey("onChatLeaveError");var Ps=babelHelpers.classPrivateFieldLooseKey("showNotification");var Fs=babelHelpers.classPrivateFieldLooseKey("getErrorCode");class Ls{constructor(){Object.defineProperty(this,Fs,{value:ys});Object.defineProperty(this,Ps,{value:Bs});Object.defineProperty(this,us,{value:ms});Object.defineProperty(this,gs,{value:fs});Object.defineProperty(this,vs,{value:Hs});Object.defineProperty(this,hs,{writable:true,value:void 0});Object.defineProperty(this,ps,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,hs)[hs]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ps)[ps]=u.Core.getRestClient()}addToChat(e){const s={chat_id:e.chatId,users:e.members,hide_history:!e.showHistory};return babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].callMethod(F.RestMethod.imChatUserAdd,s)}async kickUserFromChat(e,s){const a={dialogId:e,userId:s};try{await babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].callMethod(F.RestMethod.imV2ChatDeleteUser,a)}catch(e){babelHelpers.classPrivateFieldLooseBase(this,gs)[gs](e)}}async leaveChat(e){const s={dialogId:e,userId:u.Core.getUserId()};try{await babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].callMethod(F.RestMethod.imV2ChatDeleteUser,s);babelHelpers.classPrivateFieldLooseBase(this,vs)[vs](e)}catch(e){babelHelpers.classPrivateFieldLooseBase(this,us)[us](e)}}joinChat(e){v.Logger.warn(`UserService: join chat ${e}`);babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].dispatch("chats/update",{dialogId:e,fields:{role:F.UserRole.member}});babelHelpers.classPrivateFieldLooseBase(this,ps)[ps].callMethod(F.RestMethod.imV2ChatJoin,{dialogId:e}).catch((e=>{console.error("UserService: error joining chat",e)}))}addManager(e,s){v.Logger.warn(`UserService: add manager ${s} to ${e}`);const{managerList:a}=babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].getters["chats/get"](e);if(a.includes(s)){return}const t=[...a,s];babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].dispatch("chats/update",{dialogId:e,fields:{managerList:t}});const r={data:{dialogId:e,userIds:[s]}};P.runAction(F.RestMethod.imV2ChatAddManagers,r).catch((e=>{console.error("UserService: add manager error",e)}))}removeManager(e,s){v.Logger.warn(`UserService: remove manager ${s} from ${e}`);const{managerList:a}=babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].getters["chats/get"](e);if(!a.includes(s)){return}const t=a.filter((e=>e!==s));babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].dispatch("chats/update",{dialogId:e,fields:{managerList:t}});const r={data:{dialogId:e,userIds:[s]}};P.runAction(F.RestMethod.imV2ChatDeleteManagers,r).catch((e=>{console.error("UserService: remove manager error",e)}))}}function Hs(e){void babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].dispatch("chats/update",{dialogId:e,fields:{inited:false}});void babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].dispatch("recent/delete",{id:e});const s=babelHelpers.classPrivateFieldLooseBase(this,hs)[hs].getters["application/isChatOpen"](e);if(s){void r.Messenger.openChat()}}function fs(e){var s;console.error("UserService: error kicking from chat",e);const a={[bs.userInvitedFromStructure]:d.Loc.getMessage("IM_MESSAGE_SERVICE_KICK_CHAT_STRUCTURE_ERROR"),default:d.Loc.getMessage("IM_MESSAGE_SERVICE_KICK_CHAT_DEFAULT_ERROR")};const t=babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](e);const r=(s=a[t])!=null?s:a.default;babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps](r)}function ms(e){var s;console.error("UserService: error leaving chat",e);const a={[bs.userInvitedFromStructure]:d.Loc.getMessage("IM_MESSAGE_SERVICE_LEAVE_CHAT_STRUCTURE_ERROR"),default:d.Loc.getMessage("IM_MESSAGE_SERVICE_LEAVE_CHAT_DEFAULT_ERROR")};const t=babelHelpers.classPrivateFieldLooseBase(this,Fs)[Fs](e);const r=(s=a[t])!=null?s:a.default;babelHelpers.classPrivateFieldLooseBase(this,Ps)[Ps](r)}function Bs(e){BX.UI.Notification.Center.notify({content:e,autoHideDelay:5e3})}function ys(e){const{answer:{error:s}}=e;return s}var Is=babelHelpers.classPrivateFieldLooseKey("loadService");var Ms=babelHelpers.classPrivateFieldLooseKey("createService");var Cs=babelHelpers.classPrivateFieldLooseKey("updateService");var Ss=babelHelpers.classPrivateFieldLooseKey("renameService");var ws=babelHelpers.classPrivateFieldLooseKey("muteService");var Os=babelHelpers.classPrivateFieldLooseKey("pinService");var Us=babelHelpers.classPrivateFieldLooseKey("readService");var js=babelHelpers.classPrivateFieldLooseKey("userService");var Rs=babelHelpers.classPrivateFieldLooseKey("initServices");class Es{constructor(){Object.defineProperty(this,Rs,{value:Ks});Object.defineProperty(this,Is,{writable:true,value:void 0});Object.defineProperty(this,Ms,{writable:true,value:void 0});Object.defineProperty(this,Cs,{writable:true,value:void 0});Object.defineProperty(this,Ss,{writable:true,value:void 0});Object.defineProperty(this,ws,{writable:true,value:void 0});Object.defineProperty(this,Os,{writable:true,value:void 0});Object.defineProperty(this,Us,{writable:true,value:void 0});Object.defineProperty(this,js,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Rs)[Rs]()}loadChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].loadChat(e)}loadChatWithMessages(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].loadChatWithMessages(e)}loadChatWithContext(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].loadChatWithContext(e,s)}loadComments(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].loadComments(e)}loadCommentInfo(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].loadCommentInfo(e)}prepareDialogId(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].prepareDialogId(e)}resetChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Is)[Is].resetChat(e)}createChat(e){return babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms].createChat(e)}prepareAvatar(e){return babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs].prepareAvatar(e)}changeAvatar(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs].changeAvatar(e,s)}renameChat(e,s){return babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss].renameChat(e,s)}muteChat(e){babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].muteChat(e)}unmuteChat(e){babelHelpers.classPrivateFieldLooseBase(this,ws)[ws].unmuteChat(e)}pinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Os)[Os].pinChat(e)}unpinChat(e){babelHelpers.classPrivateFieldLooseBase(this,Os)[Os].unpinChat(e)}readAll(){return babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].readAll()}readDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].readDialog(e)}unreadDialog(e){babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].unreadDialog(e)}readMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].readMessage(e,s)}clearDialogMark(e){babelHelpers.classPrivateFieldLooseBase(this,Us)[Us].clearDialogMark(e)}leaveChat(e){babelHelpers.classPrivateFieldLooseBase(this,js)[js].leaveChat(e)}kickUserFromChat(e,s){babelHelpers.classPrivateFieldLooseBase(this,js)[js].kickUserFromChat(e,s)}addToChat(e){return babelHelpers.classPrivateFieldLooseBase(this,js)[js].addToChat(e)}joinChat(e){babelHelpers.classPrivateFieldLooseBase(this,js)[js].joinChat(e)}addManager(e,s){babelHelpers.classPrivateFieldLooseBase(this,js)[js].addManager(e,s)}removeManager(e,s){babelHelpers.classPrivateFieldLooseBase(this,js)[js].removeManager(e,s)}}function Ks(){babelHelpers.classPrivateFieldLooseBase(this,Is)[Is]=new oe;babelHelpers.classPrivateFieldLooseBase(this,Ms)[Ms]=new Ie;babelHelpers.classPrivateFieldLooseBase(this,Cs)[Cs]=new we;babelHelpers.classPrivateFieldLooseBase(this,Ss)[Ss]=new Re;babelHelpers.classPrivateFieldLooseBase(this,ws)[ws]=new xe;babelHelpers.classPrivateFieldLooseBase(this,Os)[Os]=new Ve;babelHelpers.classPrivateFieldLooseBase(this,Us)[Us]=new as;babelHelpers.classPrivateFieldLooseBase(this,js)[js]=new Ls}var Ts=babelHelpers.classPrivateFieldLooseKey("store");var Ds=babelHelpers.classPrivateFieldLooseKey("chatId");var As=babelHelpers.classPrivateFieldLooseKey("userManager");var xs=babelHelpers.classPrivateFieldLooseKey("preparedHistoryMessages");var _s=babelHelpers.classPrivateFieldLooseKey("preparedUnreadMessages");var ks=babelHelpers.classPrivateFieldLooseKey("isLoading");var Ns=babelHelpers.classPrivateFieldLooseKey("prepareInitialMessages");var Vs=babelHelpers.classPrivateFieldLooseKey("handleLoadedMessages");var Xs=babelHelpers.classPrivateFieldLooseKey("updateModels");var Gs=babelHelpers.classPrivateFieldLooseKey("setDialogInited");var $s=babelHelpers.classPrivateFieldLooseKey("getDialog");class Ws{constructor(e){Object.defineProperty(this,$s,{value:Js});Object.defineProperty(this,Gs,{value:Qs});Object.defineProperty(this,Xs,{value:Ys});Object.defineProperty(this,Vs,{value:zs});Object.defineProperty(this,Ns,{value:qs});Object.defineProperty(this,Ts,{writable:true,value:void 0});Object.defineProperty(this,Ds,{writable:true,value:void 0});Object.defineProperty(this,As,{writable:true,value:void 0});Object.defineProperty(this,xs,{writable:true,value:[]});Object.defineProperty(this,_s,{writable:true,value:[]});Object.defineProperty(this,ks,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,As)[As]=new c.UserManager;babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]=e}loadUnread(){if(babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]||!babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().hasNextPage){return Promise.resolve(false)}v.Logger.warn("MessageService: loadUnread");const e=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["messages/getLastId"](babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);if(!e){v.Logger.warn("MessageService: no lastUnreadMessageId, cant load unread");return Promise.resolve(false)}babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds],filter:{lastId:e},order:{id:"ASC"},limit:Ws.MESSAGE_REQUEST_LIMIT};return P.runAction(F.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{v.Logger.warn("MessageService: loadUnread result",e);babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]=e.messages;return babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false;return true})).catch((e=>{console.error("MessageService: loadUnread error:",e);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false}))}loadHistory(){if(babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]||!babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().hasPrevPage){return Promise.resolve(false)}v.Logger.warn("MessageService: loadHistory");const e=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["messages/getFirstId"](babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);if(!e){v.Logger.warn("MessageService: no lastHistoryMessageId, cant load unread");return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=true;const s={chatId:babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds],filter:{lastId:e},order:{id:"DESC"},limit:Ws.MESSAGE_REQUEST_LIMIT};return P.runAction(F.RestMethod.imV2ChatMessageTail,{data:s}).then((e=>{v.Logger.warn("MessageService: loadHistory result",e);babelHelpers.classPrivateFieldLooseBase(this,xs)[xs]=e.messages;const s=e.hasNextPage;const a={...e,hasPrevPage:s,hasNextPage:null};return babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](a)})).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false;return true})).catch((e=>{console.error("MessageService: loadHistory error:",e);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false}))}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,xs)[xs].length>0}drawPreparedHistoryMessages(){if(!this.hasPreparedHistoryMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,xs)[xs]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,xs)[xs]=[];return true}))}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,_s)[_s].length>0}drawPreparedUnreadMessages(){if(!this.hasPreparedUnreadMessages()){return Promise.resolve()}return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/setChatCollection",{messages:babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]}).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,_s)[_s]=[];return true}))}async loadFirstPage(){v.Logger.warn("MessageService: loadFirstPage for: ",babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=true;const e={data:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds],limit:Ws.MESSAGE_REQUEST_LIMIT,order:{id:"ASC"}}};const s=await P.runAction(F.RestMethod.imV2ChatMessageTail,e).catch((e=>{console.error("MessageService: loadFirstPage error:",e);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false;throw new Error(e)}));v.Logger.warn("MessageService: loadFirstPage result",s);await babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](s);await babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().dialogId,fields:{hasPrevPage:false,hasNextPage:s.hasNextPage}});babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false}loadContext(e){const s={[F.RestMethod.imV2ChatMessageGetContext]:{id:e,range:Ws.MESSAGE_REQUEST_LIMIT},[F.RestMethod.imV2ChatMessageRead]:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds],ids:[e]}};v.Logger.warn("MessageService: loadContext for: ",e);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=true;return P.callBatch(s).then((e=>{v.Logger.warn("MessageService: loadContext result",e);return babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](e[F.RestMethod.imV2ChatMessageGetContext])})).catch((e=>{console.error("MessageService: loadContext error:",e);throw new Error(e)})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false}))}async loadContextByChatId(e){const s={data:{commentChatId:e}};const a=await P.runAction(F.RestMethod.imV2ChatMessageGetContext,s).catch((e=>{console.error("MessageService: loadHistory error:",e)}));const t=a.commentInfo;const r=t.find((s=>s.chatId===e));const i=r==null?void 0:r.messageId;v.Logger.warn("MessageService: loadContextByChatId result",a);void babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](a);return i}reloadMessageList(){v.Logger.warn("MessageService: loadChatOnExit for: ",babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);let e=0;if(babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().chatId<=0){return Promise.resolve()}if(babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().markedId){e=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().markedId}else if(babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().savedPositionMessageId){e=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().savedPositionMessageId}const s=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().inited;babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs](false);if(e){return this.loadContext(e).catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs](true,s)}))}return this.loadInitialMessages().catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,Gs)[Gs](true,s)}))}async loadInitialMessages(){v.Logger.warn("MessageService: loadInitialMessages for: ",babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=true;const e={data:{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds],limit:Ws.MESSAGE_REQUEST_LIMIT}};const s=await P.runAction(F.RestMethod.imV2ChatMessageList,e).catch((e=>{console.error("MessageService: loadInitialMessages error:",e);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false;throw new Error(e)}));v.Logger.warn("MessageService: loadInitialMessages result",s);s.messages=babelHelpers.classPrivateFieldLooseBase(this,Ns)[Ns](s.messages);await babelHelpers.classPrivateFieldLooseBase(this,Vs)[Vs](s);babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]=false}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,ks)[ks]}}function qs(e){if(e.length===0){return e}const s=babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().lastMessageId;const a=Math.max(...e.map((e=>e.id)));if(a>=s){return e}const t=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["messages/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds]);const r=t.filter((e=>e.id>a));v.Logger.warn("MessageService: loadInitialMessages: local id is higher than server one",r);return[...e,...r]}function zs(e){const{messages:s}=e;const a=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/setChatCollection",{messages:s,clearCollection:true});const t=babelHelpers.classPrivateFieldLooseBase(this,Xs)[Xs](e);return Promise.all([a,t])}function Ys(e){const{files:s,users:a,usersShort:t,reactions:r,hasPrevPage:l,hasNextPage:o,additionalMessages:d,commentInfo:c,copilot:n}=e;const b=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().dialogId,fields:{hasPrevPage:l,hasNextPage:o}});const h=Promise.all([babelHelpers.classPrivateFieldLooseBase(this,As)[As].setUsersToModel(a),babelHelpers.classPrivateFieldLooseBase(this,As)[As].addUsersToModel(t)]);const p=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("files/set",s);const v=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/reactions/set",r);const g=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/store",d);const u=babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("messages/comments/set",c);const P=new i.CopilotManager;const F=P.handleChatLoadResponse(n);return Promise.all([b,p,h,v,g,u,F])}function Qs(e,s=true){const a={inited:e,loading:!e};if(e===true&&!s){delete a.inited}babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].dispatch("chats/update",{dialogId:babelHelpers.classPrivateFieldLooseBase(this,$s)[$s]().dialogId,fields:a})}function Js(){return babelHelpers.classPrivateFieldLooseBase(this,Ts)[Ts].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Ds)[Ds])}Ws.MESSAGE_REQUEST_LIMIT=25;var Zs=babelHelpers.classPrivateFieldLooseKey("store");var ea=babelHelpers.classPrivateFieldLooseKey("restClient");class sa{constructor(){Object.defineProperty(this,Zs,{writable:true,value:void 0});Object.defineProperty(this,ea,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ea)[ea]=u.Core.getRestClient()}pinMessage(e,s){v.Logger.warn(`Dialog: PinManager: pin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].dispatch("messages/pin/add",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,ea)[ea].callMethod(F.RestMethod.imV2ChatMessagePin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error pinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].dispatch("messages/pin/delete",{chatId:e,messageId:s})}))}unpinMessage(e,s){v.Logger.warn(`Dialog: PinManager: unpin message ${s}`);babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].dispatch("messages/pin/delete",{chatId:e,messageId:s});babelHelpers.classPrivateFieldLooseBase(this,ea)[ea].callMethod(F.RestMethod.imV2ChatMessageUnpin,{id:s}).catch((a=>{console.error("Dialog: PinManager: error unpinning message",a);babelHelpers.classPrivateFieldLooseBase(this,Zs)[Zs].dispatch("messages/pin/add",{chatId:e,messageId:s})}))}}var aa=babelHelpers.classPrivateFieldLooseKey("updateMessageModel");var ta=babelHelpers.classPrivateFieldLooseKey("getMessage");class ra{constructor(){Object.defineProperty(this,ta,{value:la});Object.defineProperty(this,aa,{value:ia})}editMessageText(e,s){v.Logger.warn("MessageService: editMessageText",e,s);const a=babelHelpers.classPrivateFieldLooseBase(this,ta)[ta](e);if(!a){return}babelHelpers.classPrivateFieldLooseBase(this,aa)[aa](e,s);const t={data:{id:e,fields:{message:s}}};P.runAction(F.RestMethod.imV2ChatMessageUpdate,t).catch((e=>{v.Logger.error("MessageService: editMessageText error:",e)}))}}function ia(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ta)[ta](e);const t=a.viewedByOthers;u.Core.getStore().dispatch("messages/update",{id:e,fields:{text:s,isEdited:t}})}function la(e){return u.Core.getStore().getters["messages/getById"](e)}var oa=babelHelpers.classPrivateFieldLooseKey("store");var da=babelHelpers.classPrivateFieldLooseKey("chatId");var ca=babelHelpers.classPrivateFieldLooseKey("shallowMessageDelete");var na=babelHelpers.classPrivateFieldLooseKey("canDeleteCompletely");var ba=babelHelpers.classPrivateFieldLooseKey("completeMessageDelete");var ha=babelHelpers.classPrivateFieldLooseKey("updateRecentForCompleteDelete");var pa=babelHelpers.classPrivateFieldLooseKey("updateChatForCompleteDelete");var va=babelHelpers.classPrivateFieldLooseKey("deleteMessageOnServer");var ga=babelHelpers.classPrivateFieldLooseKey("deleteTemporaryMessage");var ua=babelHelpers.classPrivateFieldLooseKey("getPreviousMessageId");var Pa=babelHelpers.classPrivateFieldLooseKey("sendDeleteEvent");var Fa=babelHelpers.classPrivateFieldLooseKey("getChat");class La{constructor(e){Object.defineProperty(this,Fa,{value:wa});Object.defineProperty(this,Pa,{value:Sa});Object.defineProperty(this,ua,{value:Ca});Object.defineProperty(this,ga,{value:Ma});Object.defineProperty(this,va,{value:Ia});Object.defineProperty(this,pa,{value:ya});Object.defineProperty(this,ha,{value:Ba});Object.defineProperty(this,ba,{value:ma});Object.defineProperty(this,na,{value:fa});Object.defineProperty(this,ca,{value:Ha});Object.defineProperty(this,oa,{writable:true,value:void 0});Object.defineProperty(this,da,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,da)[da]=e;babelHelpers.classPrivateFieldLooseBase(this,oa)[oa]=u.Core.getStore()}async deleteMessage(e){v.Logger.warn("MessageService: deleteMessage",e);if(b.Utils.text.isUuidV4(e)){babelHelpers.classPrivateFieldLooseBase(this,ga)[ga](e);return}babelHelpers.classPrivateFieldLooseBase(this,Pa)[Pa](e);const s=babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].getters["messages/getById"](e);if(babelHelpers.classPrivateFieldLooseBase(this,na)[na](s)){void babelHelpers.classPrivateFieldLooseBase(this,ba)[ba](s);return}void babelHelpers.classPrivateFieldLooseBase(this,ca)[ca](s)}}function Ha(e){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("messages/update",{id:e.id,fields:{text:"",isDeleted:true,files:[],attach:[],replyId:0}});return babelHelpers.classPrivateFieldLooseBase(this,va)[va](e.id)}function fa(e){const s=[F.ChatType.channel,F.ChatType.openChannel,F.ChatType.generalChannel];const a=[F.ChatType.comment];const t=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]();if(s.includes(t.type)){return true}if(a.includes(t.type)){return false}return!e.viewedByOthers}function ma(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]();if(e.id===s.lastMessageId){const s=babelHelpers.classPrivateFieldLooseBase(this,ua)[ua](e.id);babelHelpers.classPrivateFieldLooseBase(this,ha)[ha](s);babelHelpers.classPrivateFieldLooseBase(this,pa)[pa](s)}babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("messages/delete",{id:e.id});return babelHelpers.classPrivateFieldLooseBase(this,va)[va](e.id)}function Ba(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]();if(!e){babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("recent/delete",{id:s.dialogId});return}babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("recent/update",{id:s.dialogId,fields:{messageId:e}})}function ya(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]();babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("chats/update",{dialogId:s.dialogId,fields:{lastMessageId:e,lastId:e}});babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("chats/clearLastMessageViews",{dialogId:s.dialogId})}function Ia(e){return P.runAction(F.RestMethod.imV2ChatMessageDelete,{data:{id:e}}).catch((e=>{console.error("MessageService: deleteMessage error:",e)}))}function Ma(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Fa)[Fa]();const a=babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].getters["recent/get"](s.dialogId);if(a.messageId===e){const a=babelHelpers.classPrivateFieldLooseBase(this,ua)[ua](e);babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("recent/update",{id:s.dialogId,fields:{messageId:a}})}babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].dispatch("messages/delete",{id:e})}function Ca(e){var s;const a=babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].getters["messages/getPreviousMessage"]({messageId:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,da)[da]});return(s=a==null?void 0:a.id)!=null?s:0}function Sa(e){h.EventEmitter.emit(F.EventType.dialog.onMessageDeleted,{messageId:e})}function wa(){return babelHelpers.classPrivateFieldLooseBase(this,oa)[oa].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,da)[da])}var Oa=babelHelpers.classPrivateFieldLooseKey("chatId");var Ua=babelHelpers.classPrivateFieldLooseKey("store");var ja=babelHelpers.classPrivateFieldLooseKey("restClient");class Ra{constructor(e){Object.defineProperty(this,Oa,{writable:true,value:void 0});Object.defineProperty(this,Ua,{writable:true,value:void 0});Object.defineProperty(this,ja,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa]=e;babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,ja)[ja]=u.Core.getRestClient()}markMessage(e){v.Logger.warn("MessageService: markMessage",e);const{dialogId:s}=babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua].getters["chats/getByChatId"](babelHelpers.classPrivateFieldLooseBase(this,Oa)[Oa]);babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua].dispatch("recent/unread",{id:s,action:true});babelHelpers.classPrivateFieldLooseBase(this,Ua)[Ua].dispatch("chats/update",{dialogId:s,fields:{markedId:e}});babelHelpers.classPrivateFieldLooseBase(this,ja)[ja].callMethod(F.RestMethod.imV2ChatMessageMark,{dialogId:s,id:e}).catch((e=>{console.error("MessageService: error marking message",e)}))}}var Ea=babelHelpers.classPrivateFieldLooseKey("chatId");var Ka=babelHelpers.classPrivateFieldLooseKey("store");var Ta=babelHelpers.classPrivateFieldLooseKey("restClient");class Da{constructor(e){Object.defineProperty(this,Ea,{writable:true,value:void 0});Object.defineProperty(this,Ka,{writable:true,value:void 0});Object.defineProperty(this,Ta,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea]=e;babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta]=u.Core.getRestClient()}addMessageToFavorite(e){v.Logger.warn("MessageService: addMessageToFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta].callMethod(F.RestMethod.imChatFavoriteAdd,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error adding message to favorite",e)}));BX.UI.Notification.Center.notify({content:d.Loc.getMessage("IM_MESSAGE_SERVICE_ADD_MESSAGE_TO_FAVORITE_SUCCESS")})}removeMessageFromFavorite(e){v.Logger.warn("MessageService: removeMessageFromFavorite",e);babelHelpers.classPrivateFieldLooseBase(this,Ka)[Ka].dispatch("sidebar/favorites/deleteByMessageId",{chatId:babelHelpers.classPrivateFieldLooseBase(this,Ea)[Ea],messageId:e});babelHelpers.classPrivateFieldLooseBase(this,Ta)[Ta].callMethod(F.RestMethod.imChatFavoriteDelete,{MESSAGE_ID:e}).catch((e=>{console.error("MessageService: error removing message from favorite",e)}))}}var Aa=babelHelpers.classPrivateFieldLooseKey("loadService");var xa=babelHelpers.classPrivateFieldLooseKey("pinService");var _a=babelHelpers.classPrivateFieldLooseKey("editService");var ka=babelHelpers.classPrivateFieldLooseKey("deleteService");var Na=babelHelpers.classPrivateFieldLooseKey("markService");var Va=babelHelpers.classPrivateFieldLooseKey("favoriteService");var Xa=babelHelpers.classPrivateFieldLooseKey("initServices");class Ga{static getMessageRequestLimit(){return Ws.MESSAGE_REQUEST_LIMIT}constructor(e){Object.defineProperty(this,Xa,{value:$a});Object.defineProperty(this,Aa,{writable:true,value:void 0});Object.defineProperty(this,xa,{writable:true,value:void 0});Object.defineProperty(this,_a,{writable:true,value:void 0});Object.defineProperty(this,ka,{writable:true,value:void 0});Object.defineProperty(this,Na,{writable:true,value:void 0});Object.defineProperty(this,Va,{writable:true,value:void 0});const{chatId:s}=e;babelHelpers.classPrivateFieldLooseBase(this,Xa)[Xa](s)}loadUnread(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadUnread()}loadHistory(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadHistory()}hasPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].hasPreparedHistoryMessages()}drawPreparedHistoryMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].drawPreparedHistoryMessages()}hasPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].hasPreparedUnreadMessages()}drawPreparedUnreadMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].drawPreparedUnreadMessages()}isLoading(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].isLoading()}loadContext(e){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadContext(e)}loadContextByChatId(e){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadContextByChatId(e)}loadFirstPage(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadFirstPage()}reloadMessageList(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].reloadMessageList()}loadInitialMessages(){return babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa].loadInitialMessages()}pinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,xa)[xa].pinMessage(e,s)}unpinMessage(e,s){babelHelpers.classPrivateFieldLooseBase(this,xa)[xa].unpinMessage(e,s)}markMessage(e){babelHelpers.classPrivateFieldLooseBase(this,Na)[Na].markMessage(e)}addMessageToFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Va)[Va].addMessageToFavorite(e)}removeMessageFromFavorite(e){babelHelpers.classPrivateFieldLooseBase(this,Va)[Va].removeMessageFromFavorite(e)}editMessageText(e,s){babelHelpers.classPrivateFieldLooseBase(this,_a)[_a].editMessageText(e,s)}deleteMessage(e){babelHelpers.classPrivateFieldLooseBase(this,ka)[ka].deleteMessage(e)}}function $a(e){babelHelpers.classPrivateFieldLooseBase(this,Aa)[Aa]=new Ws(e);babelHelpers.classPrivateFieldLooseBase(this,_a)[_a]=new ra;babelHelpers.classPrivateFieldLooseBase(this,ka)[ka]=new La(e);babelHelpers.classPrivateFieldLooseBase(this,xa)[xa]=new sa;babelHelpers.classPrivateFieldLooseBase(this,Na)[Na]=new Ra(e);babelHelpers.classPrivateFieldLooseBase(this,Va)[Va]=new Da(e)}var Wa=babelHelpers.classPrivateFieldLooseKey("store");var qa=babelHelpers.classPrivateFieldLooseKey("processMessageSending");var za=babelHelpers.classPrivateFieldLooseKey("handleAddingMessageToModels");var Ya=babelHelpers.classPrivateFieldLooseKey("sendAndProcessMessage");var Qa=babelHelpers.classPrivateFieldLooseKey("prepareMessage");var Ja=babelHelpers.classPrivateFieldLooseKey("prepareMessageWithFiles");var Za=babelHelpers.classPrivateFieldLooseKey("preparePrompt");var et=babelHelpers.classPrivateFieldLooseKey("handlePagination");var st=babelHelpers.classPrivateFieldLooseKey("addMessageToModels");var at=babelHelpers.classPrivateFieldLooseKey("addMessageToRecent");var tt=babelHelpers.classPrivateFieldLooseKey("sendMessageToServer");var rt=babelHelpers.classPrivateFieldLooseKey("updateModels");var it=babelHelpers.classPrivateFieldLooseKey("updateMessageError");var lt=babelHelpers.classPrivateFieldLooseKey("removeMessageError");var ot=babelHelpers.classPrivateFieldLooseKey("sendScrollEvent");var dt=babelHelpers.classPrivateFieldLooseKey("getDialog");var ct=babelHelpers.classPrivateFieldLooseKey("getDialogByChatId");var nt=babelHelpers.classPrivateFieldLooseKey("needToSetAsViewed");var bt=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageResponse");var ht=babelHelpers.classPrivateFieldLooseKey("handleForwardMessageError");var pt=babelHelpers.classPrivateFieldLooseKey("prepareForwardMessages");var vt=babelHelpers.classPrivateFieldLooseKey("prepareForwardParams");var gt=babelHelpers.classPrivateFieldLooseKey("prepareSendForwardRequest");var ut=babelHelpers.classPrivateFieldLooseKey("addForwardsToModels");var Pt=babelHelpers.classPrivateFieldLooseKey("getForwardUuidMap");var Ft=babelHelpers.classPrivateFieldLooseKey("buildForwardContextId");var Lt=babelHelpers.classPrivateFieldLooseKey("logSendErrors");class Ht{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,Lt,{value:$t});Object.defineProperty(this,Ft,{value:Gt});Object.defineProperty(this,Pt,{value:Xt});Object.defineProperty(this,ut,{value:Vt});Object.defineProperty(this,gt,{value:Nt});Object.defineProperty(this,vt,{value:kt});Object.defineProperty(this,pt,{value:_t});Object.defineProperty(this,ht,{value:xt});Object.defineProperty(this,bt,{value:At});Object.defineProperty(this,nt,{value:Dt});Object.defineProperty(this,ct,{value:Tt});Object.defineProperty(this,dt,{value:Kt});Object.defineProperty(this,ot,{value:Et});Object.defineProperty(this,lt,{value:Rt});Object.defineProperty(this,it,{value:jt});Object.defineProperty(this,rt,{value:Ut});Object.defineProperty(this,tt,{value:Ot});Object.defineProperty(this,at,{value:wt});Object.defineProperty(this,st,{value:St});Object.defineProperty(this,et,{value:Ct});Object.defineProperty(this,Za,{value:Mt});Object.defineProperty(this,Ja,{value:It});Object.defineProperty(this,Qa,{value:yt});Object.defineProperty(this,Ya,{value:Bt});Object.defineProperty(this,za,{value:mt});Object.defineProperty(this,qa,{value:ft});Object.defineProperty(this,Wa,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa]=u.Core.getStore()}async sendMessage(e){const{text:s=""}=e;if(!d.Type.isStringFilled(s)){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage",e);const a=babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa](e);return babelHelpers.classPrivateFieldLooseBase(this,qa)[qa](a)}async sendMessageWithFiles(e){const{text:s="",fileIds:a=[]}=e;if(!d.Type.isStringFilled(s)&&!d.Type.isArrayFilled(a)){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage with files",e);const t=babelHelpers.classPrivateFieldLooseBase(this,Ja)[Ja](e);await babelHelpers.classPrivateFieldLooseBase(this,za)[za](t);return Promise.resolve()}async forwardMessages(e){const{forwardIds:s,dialogId:a,text:t}=e;if(!d.Type.isArrayFilled(s)){return Promise.resolve()}v.Logger.warn("SendingService: forwardMessages",e);await babelHelpers.classPrivateFieldLooseBase(this,et)[et](a);let r=null;if(d.Type.isStringFilled(t)){r=babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa](e);await babelHelpers.classPrivateFieldLooseBase(this,st)[st](r)}const i=babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt](s);const l=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt](e,i);await babelHelpers.classPrivateFieldLooseBase(this,ut)[ut](l);babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]({force:true,dialogId:a});try{const e=babelHelpers.classPrivateFieldLooseBase(this,gt)[gt]({forwardUuidMap:i,commentMessage:r,dialogId:a});const s=await babelHelpers.classPrivateFieldLooseBase(this,tt)[tt](e);v.Logger.warn("SendingService: forwardMessage result -",s);babelHelpers.classPrivateFieldLooseBase(this,bt)[bt]({response:s,dialogId:a,commentMessage:r})}catch(e){babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]({commentMessage:r,forwardUuidMap:i});babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](e,"forwardMessage")}return Promise.resolve()}async retrySendMessage(e){const{tempMessageId:s,dialogId:a}=e;const t=babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["messages/getById"](s);if(!t){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,lt)[lt](s);const r=babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa]({text:t.text,dialogId:a,tempMessageId:t.id,replyId:t.replyId});return babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya](r)}async sendCopilotPrompt(e){const{text:s=""}=e;if(!d.Type.isStringFilled(s)){return Promise.resolve()}v.Logger.warn("SendingService: sendCopilotPrompt",e);const a=babelHelpers.classPrivateFieldLooseBase(this,Za)[Za](e);return babelHelpers.classPrivateFieldLooseBase(this,qa)[qa](a)}}async function ft(e){await babelHelpers.classPrivateFieldLooseBase(this,za)[za](e);return babelHelpers.classPrivateFieldLooseBase(this,Ya)[Ya](e)}async function mt(e){await babelHelpers.classPrivateFieldLooseBase(this,et)[et](e.dialogId);await babelHelpers.classPrivateFieldLooseBase(this,st)[st](e);babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]({force:true,dialogId:e.dialogId})}async function Bt(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,tt)[tt](e).catch((s=>{babelHelpers.classPrivateFieldLooseBase(this,it)[it](e.temporaryId);babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](s,"sendAndProcessMessage")}));v.Logger.warn("SendingService: sendAndProcessMessage result -",s);const{id:a}=s;if(!a){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,rt)[rt]({oldId:e.temporaryId,newId:a,dialogId:e.dialogId});return Promise.resolve()}function yt(e){const{text:s,tempMessageId:a,dialogId:t,replyId:r,forwardIds:i}=e;const l={authorId:u.Core.getUserId(),unread:false,sending:true};return{text:s,dialogId:t,chatId:babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](t).chatId,temporaryId:a!=null?a:b.Utils.text.getUuidV4(),replyId:r,forwardIds:i,viewedByOthers:babelHelpers.classPrivateFieldLooseBase(this,nt)[nt](t),...l}}function It(e){const{fileIds:s}=e;if(!d.Type.isArrayFilled(s)){throw new Error("SendingService: sendMessageWithFile: no fileId provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa](e),params:{FILE_ID:s}}}function Mt(e){const{copilot:s}=e;if(!s||!s.promptCode){throw new Error("SendingService: preparePrompt: no code provided")}return{...babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa](e),copilot:s}}function Ct(e){if(!babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](e).hasNextPage){return Promise.resolve()}v.Logger.warn("SendingService: sendMessage: there are unread pages, move to chat end");const s=new Ga({chatId:babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](e).chatId});return s.loadContext(babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](e).lastMessageId).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,ot)[ot]({dialogId:e})})).catch((e=>{console.error("SendingService: loadContext error",e)}))}function St(e){babelHelpers.classPrivateFieldLooseBase(this,at)[at](e);void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("chats/clearLastMessageViews",{dialogId:e.dialogId});return babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/add",e)}function wt(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["recent/get"](e.dialogId);if(!s||e.text===""){return}void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("recent/update",{id:e.dialogId,fields:{messageId:e.temporaryId}})}function Ot(e){const s={};if(e.replyId){s.replyId=e.replyId}if(e.forwardIds){s.forwardIds=e.forwardIds}if(e.text){s.message=e.text;s.templateId=e.temporaryId}if(e.copilot){s.copilot=e.copilot}const a={dialogId:e.dialogId.toString(),fields:s};return P.runAction(F.RestMethod.imV2ChatMessageSend,{data:a})}function Ut(e){const{oldId:s,newId:a,dialogId:t}=e;void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/updateWithId",{id:s,fields:{id:a}});void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("chats/update",{dialogId:t,fields:{lastId:a,lastMessageId:a}});void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("recent/update",{id:t,fields:{messageId:a}})}function jt(e){void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/update",{id:e,fields:{error:true}})}function Rt(e){void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/update",{id:e,fields:{sending:true,error:false}})}function Et(e={}){const{force:s=false,dialogId:a}=e;h.EventEmitter.emit(F.EventType.dialog.scrollToBottom,{chatId:babelHelpers.classPrivateFieldLooseBase(this,dt)[dt](a).chatId,threshold:s?F.DialogScrollThreshold.none:F.DialogScrollThreshold.halfScreenUp})}function Kt(e){return babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["chats/get"](e,true)}function Tt(e){return babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["chats/getByChatId"](e,true)}function Dt(e){return babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["users/bots/isNetwork"](e)}function At(e){const{response:s,dialogId:a,commentMessage:t}=e;const{id:r,uuidMap:i}=s;if(r){babelHelpers.classPrivateFieldLooseBase(this,rt)[rt]({oldId:t.temporaryId,newId:r,dialogId:a})}Object.entries(i).forEach((([e,s])=>{babelHelpers.classPrivateFieldLooseBase(this,rt)[rt]({oldId:e,newId:s,dialogId:a})}))}function xt({commentMessage:e,forwardUuidMap:s}){if(e){void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/update",{id:e.temporaryId,fields:{error:true}})}Object.keys(s).forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].dispatch("messages/update",{id:e,fields:{error:true}})}))}function _t(e,s){const{forwardIds:a,dialogId:t}=e;if(a.length===0){return[]}const r=[];Object.entries(s).forEach((([e,s])=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["messages/getById"](s);if(!a){return}r.push({...babelHelpers.classPrivateFieldLooseBase(this,Qa)[Qa]({dialogId:t,text:a.text,tempMessageId:e,replyId:a.replyId}),forward:babelHelpers.classPrivateFieldLooseBase(this,vt)[vt](s),attach:a.attach,isDeleted:a.isDeleted,files:a.files})}));return r}function kt(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["messages/getById"](e);const a=babelHelpers.classPrivateFieldLooseBase(this,ct)[ct](s.chatId);const t=babelHelpers.classPrivateFieldLooseBase(this,Wa)[Wa].getters["messages/isForward"](e);const r=t?s.forward.userId:s.authorId;const i=t?s.forward.chatType:a.type;let l=t?s.forward.chatTitle:a.name;if(i===F.ChatType.channel){l=null}return{id:babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft](s.chatId,e),userId:r,chatType:i,chatTitle:l}}function Nt(e){const{dialogId:s,forwardUuidMap:a,commentMessage:t}=e;const r={dialogId:s,forwardIds:a};if(t){r.text=t.text;r.temporaryId=t.temporaryId}return r}function Vt(e){const s=[];e.forEach((e=>{s.push(babelHelpers.classPrivateFieldLooseBase(this,st)[st](e))}));return Promise.all(s)}function Xt(e){const s={};e.forEach((e=>{s[b.Utils.text.getUuidV4()]=e}));return s}function Gt(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,ct)[ct](e).dialogId;if(a.startsWith("chat")){return`${a}/${s}`}const t=u.Core.getUserId();return`${a}:${t}/${s}`}function $t(e,s){e.forEach((e=>{console.error(`SendingService: ${s} error: code: ${e.code} message: ${e.message}`)}))}Ht.instance=null;class Wt{constructor(){this.store=null;this.restClient=null;this.limitPerPage=50;this.isLoading=false;this.lastId=0;this.lastType=0;this.hasMoreItemsToLoad=true;this.notificationsToDelete=new Set;this.store=u.Core.getStore();this.restClient=u.Core.getRestClient();this.deleteWithDebounce=d.Runtime.debounce(this.deleteRequest,500,this);this.userManager=new c.UserManager}loadFirstPage(){this.isLoading=true;return this.requestItems({firstPage:true})}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}delete(e){this.notificationsToDelete.add(e);this.store.dispatch("notifications/delete",{id:e});this.store.dispatch("notifications/deleteFromSearch",{id:e});this.deleteWithDebounce()}sendConfirmAction(e,s){const a={NOTIFY_ID:e,NOTIFY_VALUE:s};this.store.dispatch("notifications/delete",{id:e});this.restClient.callMethod("im.notify.confirm",a).catch((e=>{console.error(e)}))}async sendQuickAnswer(e){const{id:s,text:a,callbackSuccess:t=(()=>{}),callbackError:r=(()=>{})}=e;try{const e=await this.restClient.callMethod(F.RestMethod.imNotifyAnswer,{notify_id:s,answer_text:a});t(e)}catch(e){console.error(e);r()}}deleteRequest(){const e=[...this.notificationsToDelete];this.restClient.callMethod("im.notify.delete",{id:e}).catch((e=>{console.error(e)}));this.notificationsToDelete.clear()}requestItems({firstPage:e=false}={}){const s={LIMIT:this.limitPerPage,CONVERT_TEXT:"Y"};const a={[F.RestMethod.imNotifyGet]:[F.RestMethod.imNotifyGet,s]};if(e){a[F.RestMethod.imNotifySchemaGet]=[F.RestMethod.imNotifySchemaGet,{}]}else{s.LAST_ID=this.lastId;s.LAST_TYPE=this.lastType}return new Promise((e=>{this.restClient.callBatch(a,(s=>{v.Logger.warn("im.notify.get: result",s);e(this.handleResponse(s))}))}))}handleResponse(e){const s=e[F.RestMethod.imNotifyGet].data();this.hasMoreItemsToLoad=!this.isLastPage(s.notifications);if(s.notifications.length===0){v.Logger.warn("im.notify.get: no notifications",s);return Promise.resolve()}this.lastId=this.getLastItemId(s.notifications);this.lastType=this.getLastItemType(s.notifications);return this.updateModels(s).then((()=>{this.isLoading=false;if(e[F.RestMethod.imNotifySchemaGet]){return e[F.RestMethod.imNotifySchemaGet].data()}return{}}))}updateModels(e){this.userManager.setUsersToModel(e.users);return this.store.dispatch("notifications/initialSet",e)}getLastItemId(e){return e[e.length-1].id}getLastItemType(e){return this.getItemType(e[e.length-1])}getItemType(e){return e.notify_type===F.NotificationTypesCodes.confirm?F.NotificationTypesCodes.confirm:F.NotificationTypesCodes.simple}isLastPage(e){if(!d.Type.isArrayFilled(e)){return true}return e.length<this.limitPerPage}destroy(){v.Logger.warn("Notification service destroyed")}}var qt=babelHelpers.classPrivateFieldLooseKey("restClient");class zt{constructor(){Object.defineProperty(this,qt,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,qt)[qt]=u.Core.getRestClient()}delete({chatId:e,fileId:s}){const a={chat_id:e,file_id:s};return babelHelpers.classPrivateFieldLooseBase(this,qt)[qt].callMethod(F.RestMethod.imDiskFileDelete,a).catch((e=>{console.error("DiskService: error deleting file",e)}))}save(e){const s={file_id:e};return babelHelpers.classPrivateFieldLooseBase(this,qt)[qt].callMethod(F.RestMethod.imDiskFileSave,s).catch((e=>{console.error("DiskService: error saving file on disk",e)}))}}const Yt=10;var Qt=babelHelpers.classPrivateFieldLooseKey("uploaderRegistry");var Jt=babelHelpers.classPrivateFieldLooseKey("onUploadCancelHandler");var Zt=babelHelpers.classPrivateFieldLooseKey("addFile");var er=babelHelpers.classPrivateFieldLooseKey("onUploadCancel");var sr=babelHelpers.classPrivateFieldLooseKey("removeFileFromUploader");class ar extends h.EventEmitter{constructor(){super();Object.defineProperty(this,sr,{value:ir});Object.defineProperty(this,er,{value:rr});Object.defineProperty(this,Zt,{value:tr});Object.defineProperty(this,Qt,{writable:true,value:{}});Object.defineProperty(this,Jt,{writable:true,value:void 0});this.setEventNamespace(ar.eventNamespace);babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt]=babelHelpers.classPrivateFieldLooseBase(this,er)[er].bind(this);h.EventEmitter.subscribe(F.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt])}createUploader(e){const{diskFolderId:s,uploaderId:a,autoUpload:t}=e;babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][a]=new p.Uploader({autoUpload:t,controller:"disk.uf.integration.diskUploaderController",multiple:true,controllerOptions:{folderId:s},imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&e.getExtension()!=="gif",imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,maxFileSize:null,events:{[p.UploaderEvent.FILE_ADD_START]:e=>{this.emit(ar.events.onFileAddStart,e)},[p.UploaderEvent.FILE_UPLOAD_START]:e=>{this.emit(ar.events.onFileUploadStart,e)},[p.UploaderEvent.FILE_ADD]:e=>{const{file:s}=e.getData();this.emit(ar.events.onFileAdd,{file:s,uploaderId:a})},[p.UploaderEvent.FILE_UPLOAD_PROGRESS]:e=>{this.emit(ar.events.onFileUploadProgress,e)},[p.UploaderEvent.FILE_UPLOAD_COMPLETE]:e=>{const{file:s}=e.getData();this.emit(ar.events.onFileUploadComplete,{file:s,uploaderId:a})},[p.UploaderEvent.ERROR]:e=>{this.emit(ar.events.onFileUploadError,e)},[p.UploaderEvent.FILE_ERROR]:e=>{this.emit(ar.events.onFileUploadError,e)},[p.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:e=>{this.emit(ar.events.onMaxFileCountExceeded,e)},[p.UploaderEvent.UPLOAD_COMPLETE]:e=>{this.emit(ar.events.onUploadComplete,{uploaderId:a})}}})}start(e){babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][e].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][e].start()}destroyUploader(e){babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][e].destroy({removeFilesFromServer:false})}addFiles(e){const s=e.slice(0,Yt);const a=[];s.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,Zt)[Zt](e);if(s){a.push(s)}}));return a}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][e].getFiles()}destroy(){h.EventEmitter.unsubscribe(F.EventType.uploader.cancel,babelHelpers.classPrivateFieldLooseBase(this,Jt)[Jt])}}function tr(e){return babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt][e.uploaderId].addFile(e.file,{id:e.tempFileId,customData:{dialogId:e.dialogId,chatId:e.chatId,tempMessageId:e.tempMessageId,sendAsFile:e.sendAsFile}})}function rr(e){const{tempFileId:s,tempMessageId:a}=e.getData();if(!s||!a){return}babelHelpers.classPrivateFieldLooseBase(this,sr)[sr](s);this.emit(ar.events.onFileUploadCancel,{tempMessageId:a,tempFileId:s})}function ir(e){const s=Object.values(babelHelpers.classPrivateFieldLooseBase(this,Qt)[Qt]);for(const a of s){if(!a.getFile){continue}const s=a.getFile(e);if(s){s.remove();break}}}ar.eventNamespace="BX.Messenger.v2.Service.Uploading.UploaderWrapper";ar.events={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded",onUploadComplete:"onUploadComplete"};var lr=babelHelpers.classPrivateFieldLooseKey("store");var or=babelHelpers.classPrivateFieldLooseKey("restClient");var dr=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var cr=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var nr=babelHelpers.classPrivateFieldLooseKey("uploaderWrapper");var br=babelHelpers.classPrivateFieldLooseKey("sendingService");var hr=babelHelpers.classPrivateFieldLooseKey("uploaderFilesRegistry");var pr=babelHelpers.classPrivateFieldLooseKey("createUploader");var vr=babelHelpers.classPrivateFieldLooseKey("addFiles");var gr=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var ur=babelHelpers.classPrivateFieldLooseKey("initUploader");var Pr=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var Fr=babelHelpers.classPrivateFieldLooseKey("tryCommit");var Lr=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var Hr=babelHelpers.classPrivateFieldLooseKey("prepareFileForUploader");var fr=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var mr=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var Br=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var yr=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var Ir=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var Mr=babelHelpers.classPrivateFieldLooseKey("preparePreview");var Cr=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var Sr=babelHelpers.classPrivateFieldLooseKey("getFileType");var wr=babelHelpers.classPrivateFieldLooseKey("getFileExtension");var Or=babelHelpers.classPrivateFieldLooseKey("getDialog");var Ur=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var jr=babelHelpers.classPrivateFieldLooseKey("getChatId");var Rr=babelHelpers.classPrivateFieldLooseKey("registerFiles");var Er=babelHelpers.classPrivateFieldLooseKey("setPreviewCreatedStatus");var Kr=babelHelpers.classPrivateFieldLooseKey("setPreviewSentStatus");var Tr=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var Dr=babelHelpers.classPrivateFieldLooseKey("setAutoUpload");var Ar=babelHelpers.classPrivateFieldLooseKey("createMessagesFromFiles");var xr=babelHelpers.classPrivateFieldLooseKey("createMessageFromFiles");var _r=babelHelpers.classPrivateFieldLooseKey("readyToAddMessages");var kr=babelHelpers.classPrivateFieldLooseKey("readyToCommit");var Nr=babelHelpers.classPrivateFieldLooseKey("tryToSendMessage");var Vr=babelHelpers.classPrivateFieldLooseKey("tryToSendMessages");var Xr=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Gr=babelHelpers.classPrivateFieldLooseKey("showError");var $r=babelHelpers.classPrivateFieldLooseKey("setMessageError");class Wr{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,$r,{value:Ci});Object.defineProperty(this,Gr,{value:Mi});Object.defineProperty(this,Xr,{value:Ii});Object.defineProperty(this,Vr,{value:yi});Object.defineProperty(this,Nr,{value:Bi});Object.defineProperty(this,kr,{value:mi});Object.defineProperty(this,_r,{value:fi});Object.defineProperty(this,xr,{value:Hi});Object.defineProperty(this,Ar,{value:Li});Object.defineProperty(this,Dr,{value:Fi});Object.defineProperty(this,Tr,{value:Pi});Object.defineProperty(this,Kr,{value:ui});Object.defineProperty(this,Er,{value:gi});Object.defineProperty(this,Rr,{value:vi});Object.defineProperty(this,jr,{value:pi});Object.defineProperty(this,Ur,{value:hi});Object.defineProperty(this,Or,{value:bi});Object.defineProperty(this,wr,{value:ni});Object.defineProperty(this,Sr,{value:ci});Object.defineProperty(this,Cr,{value:di});Object.defineProperty(this,Mr,{value:oi});Object.defineProperty(this,Ir,{value:li});Object.defineProperty(this,yr,{value:ii});Object.defineProperty(this,Br,{value:ri});Object.defineProperty(this,mr,{value:ti});Object.defineProperty(this,fr,{value:ai});Object.defineProperty(this,Hr,{value:si});Object.defineProperty(this,Lr,{value:ei});Object.defineProperty(this,Fr,{value:Zr});Object.defineProperty(this,Pr,{value:Jr});Object.defineProperty(this,ur,{value:Qr});Object.defineProperty(this,gr,{value:Yr});Object.defineProperty(this,vr,{value:zr});Object.defineProperty(this,pr,{value:qr});Object.defineProperty(this,lr,{writable:true,value:void 0});Object.defineProperty(this,or,{writable:true,value:void 0});Object.defineProperty(this,dr,{writable:true,value:false});Object.defineProperty(this,cr,{writable:true,value:{}});Object.defineProperty(this,nr,{writable:true,value:void 0});Object.defineProperty(this,br,{writable:true,value:void 0});Object.defineProperty(this,hr,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,lr)[lr]=u.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,or)[or]=u.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,br)[br]=Ht.getInstance();babelHelpers.classPrivateFieldLooseBase(this,ur)[ur]()}async uploadFromClipboard(e){const{clipboardEvent:s,dialogId:a,autoUpload:t,imagesOnly:r}=e;const{clipboardData:i}=s;if(!i||!p.isFilePasted(i)){return""}s.preventDefault();let l=await p.getFilesFromDataTransfer(i);if(r){l=l.filter((e=>b.Utils.file.isImage(e.name)));if(r.length===0){return""}}const{uploaderFiles:o,uploaderId:d}=await babelHelpers.classPrivateFieldLooseBase(this,vr)[vr]({files:l,dialogId:a,autoUpload:t});if(o.length===0){return""}return d}async uploadFromInput(e){const{event:s,sendAsFile:a,autoUpload:t,dialogId:r}=e;const i=Object.values(s.target.files);if(i.length===0){return""}const{uploaderId:l}=await babelHelpers.classPrivateFieldLooseBase(this,vr)[vr]({files:i,dialogId:r,autoUpload:t,sendAsFile:a});return l}async uploadFromDragAndDrop(e){const{event:s,dialogId:a,autoUpload:t,sendAsFile:r}=e;s.preventDefault();const i=await p.getFilesFromDataTransfer(s.dataTransfer);if(i.length===0){return""}const{uploaderId:l}=await babelHelpers.classPrivateFieldLooseBase(this,vr)[vr]({files:i,dialogId:a,autoUpload:t,sendAsFile:r});return l}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].getFiles(e)}start(e){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].autoUpload=true;babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].start(e)}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const a=babelHelpers.classPrivateFieldLooseBase(this,Xr)[Xr](e,s);babelHelpers.classPrivateFieldLooseBase(this,gr)[gr](a).then((()=>{const e={tempMessageId:a.tempMessageId,fileIds:[a.tempFileId],dialogId:a.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,br)[br].sendMessageWithFiles(e)})).then((()=>{this.commitFile({chatId:a.chatId,temporaryFileId:a.tempFileId,tempMessageId:a.tempMessageId,realFileId:a.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,Cr)[Cr](e))}if(babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]){return babelHelpers.classPrivateFieldLooseBase(this,cr)[cr][e]}babelHelpers.classPrivateFieldLooseBase(this,cr)[cr][e]=babelHelpers.classPrivateFieldLooseBase(this,Pr)[Pr](e);return babelHelpers.classPrivateFieldLooseBase(this,cr)[cr][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:a,chatId:t,realFileId:r,fromDisk:i,messageText:l="",sendAsFile:o=false}=e;const d={};if(i){d.disk_id=r}else{d.upload_id=r.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,or)[or].callMethod(F.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:a,file_template_id:s,as_file:o?"Y":"N",...d}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,$r)[$r](a);babelHelpers.classPrivateFieldLooseBase(this,fr)[fr](s,0,F.FileStatus.error);v.Logger.error("commitFile error",e)}))}commitMessage(e){const s=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].dialogId;const a=babelHelpers.classPrivateFieldLooseBase(this,jr)[jr](s);const t=babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].getFiles(e).map((e=>e.getServerFileId().toString().slice(1)));const r=babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].getFiles(e).every((e=>e.getCustomData("sendAsFile")));return babelHelpers.classPrivateFieldLooseBase(this,or)[or].callMethod(F.RestMethod.imDiskFileCommit,{chat_id:a,message:babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].text,template_id:babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].tempMessageId,as_file:r?"Y":"N",upload_id:t})}sendSeparateMessagesWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr](s,a);babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr](s,true);babelHelpers.classPrivateFieldLooseBase(this,Vr)[Vr](s)}sendMessageWithFiles(e){const{uploaderId:s,text:a}=e;babelHelpers.classPrivateFieldLooseBase(this,Tr)[Tr](s,a);babelHelpers.classPrivateFieldLooseBase(this,Dr)[Dr](s,true);babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr](s)}destroy(){babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].destroy()}}function qr(e){const{dialogId:s,autoUpload:a}=e;const t=b.Utils.text.getUuidV4();return this.checkDiskFolderId(s).then((e=>{babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].createUploader({diskFolderId:e,uploaderId:t,autoUpload:a});return t}))}function zr(e){const{files:s,dialogId:a,autoUpload:t,sendAsFile:r=false}=e;return babelHelpers.classPrivateFieldLooseBase(this,pr)[pr]({dialogId:a,autoUpload:t}).then((e=>{const i=[];s.forEach((s=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Hr)[Hr](s,a,e,r);i.push(t)}));const l=babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].addFiles(i);babelHelpers.classPrivateFieldLooseBase(this,Rr)[Rr](e,l,a,t);return{uploaderFiles:l,uploaderId:e}}))}function Yr(e){return babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:u.Core.getUserId(),name:e.file.name,type:b.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:F.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur]().name})}function Qr(){babelHelpers.classPrivateFieldLooseBase(this,nr)[nr]=new ar;babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileAddStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Br)[Br](s)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileAdd,(e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,yr)[yr](s);babelHelpers.classPrivateFieldLooseBase(this,Er)[Er](a,s.getId());babelHelpers.classPrivateFieldLooseBase(this,Nr)[Nr](a)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileUploadStart,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Ir)[Ir](s)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileUploadProgress,(e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,fr)[fr](s.getId(),s.getProgress(),F.FileStatus.upload)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileUploadComplete,(async e=>{const{file:s,uploaderId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,fr)[fr](s.getId(),s.getProgress(),F.FileStatus.wait);await babelHelpers.classPrivateFieldLooseBase(this,Lr)[Lr](s);babelHelpers.classPrivateFieldLooseBase(this,Kr)[Kr](a,s.getId());void babelHelpers.classPrivateFieldLooseBase(this,Fr)[Fr](a)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileUploadError,(e=>{const{file:s,error:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,fr)[fr](s.getId(),0,F.FileStatus.error);babelHelpers.classPrivateFieldLooseBase(this,$r)[$r](s.getCustomData("tempMessageId"));babelHelpers.classPrivateFieldLooseBase(this,Gr)[Gr](a);v.Logger.error("UploadingService: upload error",a)}));babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].subscribe(ar.events.onFileUploadCancel,(e=>{const{tempMessageId:s,tempFileId:a}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,mr)[mr](s,a)}))}function Jr(e){return new Promise(((s,a)=>{babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]=true;const t=babelHelpers.classPrivateFieldLooseBase(this,jr)[jr](e);babelHelpers.classPrivateFieldLooseBase(this,or)[or].callMethod(F.RestMethod.imDiskFolderGet,{chat_id:t}).then((a=>{const{ID:t}=a.data();babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]=false;babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].commit("chats/update",{dialogId:e,fields:{diskFolderId:t}});s(t)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,dr)[dr]=false;a(e)}))}))}async function Zr(e){if(!babelHelpers.classPrivateFieldLooseBase(this,kr)[kr](e)){return}await this.commitMessage(e);babelHelpers.classPrivateFieldLooseBase(this,nr)[nr].destroyUploader(e)}async function ei(e){if(babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr](e.getBinary())===F.FileType.file||e.getExtension()==="gif"){return Promise.resolve()}const s=e.getServerFileId().toString().slice(1);const a=e.getClientPreview();if(!a){e.setCustomData("sendAsFile",true);return Promise.resolve()}const t=new FormData;t.append("id",s);t.append("previewFile",a,`preview_${e.getName()}.jpg`);return P.runAction(F.RestMethod.imDiskFilePreviewUpload,{data:t}).catch((e=>{v.Logger.error("imDiskFilePreviewUpload request error",e)}))}function si(e,s,a,t){const r=b.Utils.text.getUuidV4();const i=b.Utils.text.getUuidV4();const l=babelHelpers.classPrivateFieldLooseBase(this,jr)[jr](s);return{tempMessageId:r,tempFileId:i,file:e,dialogId:s,chatId:l,uploaderId:a,sendAsFile:t}}function ai(e,s,a){void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:a}})}function ti(e,s){void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("messages/delete",{id:e});void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/delete",{id:s})}function ri(e){const s=e.getId();const a=e.getBinary();const t=babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr](e);const r=e.getCustomData("sendAsFile");void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/add",{id:s,chatId:e.getCustomData("chatId"),authorId:u.Core.getUserId(),name:a.name,size:e.getSize(),type:r?F.FileType.file:babelHelpers.classPrivateFieldLooseBase(this,Sr)[Sr](a),extension:babelHelpers.classPrivateFieldLooseBase(this,wr)[wr](a),status:e.isFailed()?F.FileStatus.error:F.FileStatus.progress,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,Ur)[Ur]().name,...t})}function ii(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Mr)[Mr](e);void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/update",{id:e.getId(),fields:{...s}})}function li(e){void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function oi(e){if(e.getCustomData("sendAsFile")){return{}}const s={blob:e.getPreviewUrl(),width:e.getPreviewWidth(),height:e.getPreviewHeight()};const a={};if(s.blob){a.image={width:s.width,height:s.height};a.urlPreview=s.blob}if(e.getClientPreview()){a.urlShow=URL.createObjectURL(e.getBinary())}return a}function di(e){return babelHelpers.classPrivateFieldLooseBase(this,Or)[Or](e).diskFolderId}function ci(e){let s=F.FileType.file;if(e.type.startsWith("image")){s=F.FileType.image}else if(e.type.startsWith("video")){s=F.FileType.video}return s}function ni(e){return e.name.split(".").splice(-1)[0]}function bi(e){return babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].getters["chats/get"](e)}function hi(){const e=u.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].getters["users/get"](e)}function pi(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,Or)[Or](e))==null?void 0:s.chatId}function vi(e,s,a,t){if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e]){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e]={previewCreatedStatus:{},previewSentStatus:{},dialogId:a,text:"",autoUpload:t}}s.forEach((s=>{const a=s.getId();if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewCreatedStatus){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewCreatedStatus={}}babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewCreatedStatus[a]=false;babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewSentStatus[a]=false}))}function gi(e,s){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewCreatedStatus[s]=true}function ui(e,s){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].previewSentStatus[s]=true}function Pi(e,s){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].text=s}function Fi(e,s){babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].autoUpload=s}function Li(e){const s={comment:{},files:[]};const a=this.getFiles(e);const t=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].text;const r=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].dialogId;const i=t.length>0;if(a.length>1&&i){s.comment={dialogId:r,text:t}}a.forEach((e=>{var l;if(e.getError()){return}const o=b.Utils.text.getUuidV4();e.setCustomData("messageId",o);if(a.length===1&&i){e.setCustomData("messageText",t)}s.files.push({fileIds:[e.getId()],tempMessageId:e.getCustomData("tempMessageId"),dialogId:r,text:(l=e.getCustomData("messageText"))!=null?l:""})}));return s}function Hi(e){const s=b.Utils.text.getUuidV4();babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].tempMessageId=s;const a=[];const t=this.getFiles(e);t.forEach((e=>{if(!e.getError()){a.push(e.getId())}}));const r=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].text;const i=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].dialogId;return{fileIds:a,tempMessageId:s,dialogId:i,text:r}}function fi(e){if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e]||!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].autoUpload||babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].wasSent){return false}const{previewCreatedStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e];return Object.values(s).every((e=>e===true))}function mi(e){if(!babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e]){return false}const{previewSentStatus:s}=babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e];return Object.values(s).every((e=>e===true))}function Bi(e){if(!babelHelpers.classPrivateFieldLooseBase(this,_r)[_r](e)){return}babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].wasSent=true;const s=babelHelpers.classPrivateFieldLooseBase(this,xr)[xr](e);void babelHelpers.classPrivateFieldLooseBase(this,br)[br].sendMessageWithFiles(s);this.start(e)}function yi(e){if(!babelHelpers.classPrivateFieldLooseBase(this,_r)[_r](e)){return}babelHelpers.classPrivateFieldLooseBase(this,hr)[hr][e].wasSent=true;const{comment:s,files:a}=babelHelpers.classPrivateFieldLooseBase(this,Ar)[Ar](e);if(s.text){void babelHelpers.classPrivateFieldLooseBase(this,br)[br].sendMessage(s)}a.forEach((e=>{void babelHelpers.classPrivateFieldLooseBase(this,br)[br].sendMessageWithFiles(e)}));this.start(e)}function Ii(e,s){const a=b.Utils.text.getUuidV4();const t=e.id.slice(1);const r=`${a}|${t}`;return{tempMessageId:a,tempFileId:r,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,Or)[Or](s).chatId}}function Mi(e){if(e.getCode()==="MAX_FILE_SIZE_EXCEEDED"){BX.UI.Notification.Center.notify({content:`${e.getMessage()}<br>${e.getDescription()}`})}}function Ci(e){void babelHelpers.classPrivateFieldLooseBase(this,lr)[lr].dispatch("messages/update",{id:e,fields:{error:true}})}Wr.instance=null;class Si{changeSetting(e,s){v.Logger.warn("SettingsService: changeSetting",e,s);u.Core.getStore().dispatch("application/settings/set",{[e]:s});return P.runAction(F.RestMethod.imV2SettingsGeneralUpdate,{data:{userId:u.Core.getUserId(),name:e,value:s}}).catch((e=>{console.error("SettingsService: changeSetting error",e)}))}}class wi{async getDialogIdByUserCode(e){const s=await u.Core.getRestClient().callMethod(F.RestMethod.linesDialogGet,{USER_CODE:e}).catch((e=>{console.error("LinesService: error getting dialog id",e)}));const{dialog_id:a}=s.data();return a}}var Oi=babelHelpers.classPrivateFieldLooseKey("onCreateError");var Ui=babelHelpers.classPrivateFieldLooseKey("sendAnalytics");class ji{constructor(){Object.defineProperty(this,Ui,{value:Ei});Object.defineProperty(this,Oi,{value:Ri})}async createChat({roleCode:e}){const s=new Es;const{newDialogId:a,newChatId:t}=await s.createChat({type:F.ChatType.copilot,copilotMainRole:e}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Oi)[Oi](e)}));babelHelpers.classPrivateFieldLooseBase(this,Ui)[Ui]({chatId:t,dialogId:a});await s.loadChatWithMessages(a).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,Oi)[Oi](e)}));return a}}function Ri(e){console.error("Copilot chat create error",e);throw new Error("Copilot chat create error")}function Ei({chatId:e,dialogId:s}){g.Analytics.getInstance().onCreateCopilotChat({chatId:e,dialogId:s})}const Ki={subscribe(e){u.Core.getStore().dispatch("messages/comments/subscribe",e);return P.runAction(F.RestMethod.imV2ChatCommentSubscribe,{data:{postId:e,createIfNotExists:true,autoJoin:true}}).catch((e=>{console.error("CommentsService: subscribe error",e)}))},unsubscribe(e){u.Core.getStore().dispatch("messages/comments/unsubscribe",e);return P.runAction(F.RestMethod.imV2ChatCommentUnsubscribe,{data:{postId:e,createIfNotExists:true,autoJoin:true}}).catch((e=>{console.error("CommentsService: unsubscribe error",e)}))},readAllChannelComments(e){const s=u.Core.getStore().getters["chats/get"](e,true);const a=u.Core.getStore().getters["counters/getChannelCommentsCounter"](s.chatId);if(a===0){return Promise.resolve()}u.Core.getStore().dispatch("counters/readAllChannelComments",s.chatId);return P.runAction(F.RestMethod.imV2ChatCommentReadAll,{data:{dialogId:e}}).catch((e=>{console.error("CommentsService: readAllChannelComments error",e)}))}};e.RecentService=W;e.ChatService=Es;e.MessageService=Ga;e.SendingService=Ht;e.NotificationService=Wt;e.DiskService=zt;e.UploadingService=Wr;e.SettingsService=Si;e.LinesService=wi;e.CopilotService=ji;e.CommentsService=Ki})(this.BX.Messenger.v2.Provider.Service=this.BX.Messenger.v2.Provider.Service||{},BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Vue3.Vuex,BX,BX,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Event,BX.UI.Uploader,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Const);
//# sourceMappingURL=registry.bundle.map.js