this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};this.BX.UI.BBCode=this.BX.UI.BBCode||{};(function(e,t,r,a){"use strict";class n extends a.NodeFormatter{constructor(e={}){super({name:"#root",convert(){return document.createDocumentFragment()},...e})}}class o extends a.NodeFormatter{constructor(e={}){super({name:"#text",convert({node:e}){return document.createTextNode(e.toString())},...e})}}class s extends a.NodeFormatter{constructor(e={}){super({name:"#tab",convert({node:e}){return document.createTextNode(e.toString())},...e})}}class i extends a.NodeFormatter{constructor(e={}){super({name:"#linebreak",convert({node:e}){const t=e.getNextSibling();if(t&&t.getName()==="#linebreak"){return document.createElement("br")}return document.createTextNode(e.getContent())},...e})}}class c extends a.NodeFormatter{constructor(e={}){super({name:"p",convert({node:e}){return r.Dom.create({tag:e.getName(),attributes:e.getAttributes()})},...e})}}class l extends a.NodeFormatter{constructor(e={}){super({name:"b",convert({node:e}){return r.Dom.create({tag:"b",attributes:e.getAttributes()})},...e})}}class m extends a.NodeFormatter{constructor(e={}){super({name:"u",convert({node:e}){return r.Dom.create({tag:"u",attributes:e.getAttributes()})},...e})}}class d extends a.NodeFormatter{constructor(e={}){super({name:"i",convert({node:e}){return r.Dom.create({tag:"i",attributes:e.getAttributes()})},...e})}}class u extends a.NodeFormatter{constructor(e={}){super({name:"s",convert({node:e}){return r.Dom.create({tag:"s",attributes:e.getAttributes()})},...e})}}class g extends a.NodeFormatter{constructor(e={}){super({name:"span",convert({node:e}){return r.Dom.create({tag:"span",attributes:e.getAttributes()})},...e})}}class p extends a.NodeFormatter{constructor(e={}){super({name:"table",convert(){return r.Dom.create({tag:"table",attrs:{classname:"ui-formatter-table"}})},...e})}}class f extends a.NodeFormatter{constructor(e={}){super({name:"th",convert(){return r.Dom.create({tag:"th",attrs:{classname:"ui-formatter-table-head-cell"}})},...e})}}class h extends a.NodeFormatter{constructor(e={}){super({name:"td",convert(){return r.Dom.create({tag:"td",attrs:{classname:"ui-formatter-table-data-cell"}})},...e})}}class F extends a.NodeFormatter{constructor(e={}){super({name:"tr",convert(){return r.Dom.create({tag:"tr",attrs:{classname:"ui-formatter-table-row"}})},...e})}}class b extends a.NodeFormatter{constructor(e){super({name:"list",convert({node:e}){const t=e.getValue()==="1"?"ol":"ul";return r.Dom.create({tag:t,attributes:e.getAttributes()})},...e})}}class N extends a.NodeFormatter{constructor(e){super({name:"*",convert({node:e}){return r.Dom.create({tag:"li",attributes:e.getAttributes()})},...e})}}class S extends a.NodeFormatter{constructor(e={}){super({name:"quote",convert(){return r.Dom.create({tag:"blockquote",attrs:{className:"ui-formatter-blockquote"}})},...e})}}class v extends a.NodeFormatter{constructor(e={}){super({name:"code",before({node:e}){const t=e.getScheme();const r=v.trimLinebreaks(e);const a=r.getChildren();const n=[];let o=t.createText();a.forEach((e=>{if(t.isNewLine(e)){n.push(o,e);o=t.createText()}else{o.setContent(o.getContent()+e.getContent())}}));r.setChildren([...n,o]);return r},convert(){return r.Dom.create({tag:"pre",attrs:{className:"ui-formatter-code-block"}})},forChild({node:e,element:t}){if(e.getPlainTextLength()===0){return null}const a=e.getScheme();if(a.isText(e)){const t=e.toString().replaceAll(/\t/g," ".repeat(4));return r.Dom.create({tag:"span",attrs:{className:"ui-formatter-code-line"},text:t})}return t},...e})}static trimLinebreaks(e){const t=e.getScheme();let r=e.getFirstChild();while(t.isNewLine(r)){r.remove();r=e.getFirstChild()}let a=e.getLastChild();while(t.isNewLine(a)){a.remove();a=e.getFirstChild()}return e}}class x extends a.NodeFormatter{constructor(e={}){super({name:"url",validate({node:e}){const t=x.fetchNodeValue(e);return!x.startsWithJavascriptScheme(t)},before({node:e,formatter:t}){if(t.isShortLinkEnabled()&&t.isHrefStartsWithAllowedScheme(e.toPlainText())){const r=e.getScheme();const a=e.getPlainTextLength();const{shortLink:n}=t.getLinkSettings();if(a>n.maxLength){const t=x.fetchNodeValue(e);const a=r.createRoot({children:e.getChildren()});const[o,s]=a.split({offset:n.maxLength-n.lastFragmentLength});const i=s.getPlainTextLength();const c=e.clone();c.setValue(t);if(i>n.lastFragmentLength){c.appendChild(...o.getChildren(),r.createText("..."));const[,e]=s.split({offset:i-n.lastFragmentLength});c.appendChild(...e.getChildren());return c}c.setChildren([...o.getChildren(),r.createText("..."),...s.getChildren()]);return c}}return e},convert({node:e,formatter:t}){const a=(()=>{const t=e.getValue();if(r.Type.isStringFilled(t)){return t}return e.getContent()})();const n=e.getAttributes();const o=t.makeSafeHref(a);const{defaultTarget:s,attributes:i}=t.getLinkSettings();return r.Dom.create({tag:"a",attrs:{...n,...i,target:s,href:o}})},...e})}static fetchNodeValue(e){const t=e.getValue();if(r.Type.isStringFilled(t)){return t}return e.toPlainText()}static startsWithJavascriptScheme(e){if(r.Type.isStringFilled(e)){const t=/^[\u0000-\u001F ]*j[\t\n\r]*a[\t\n\r]*v[\t\n\r]*a[\t\n\r]*s[\t\n\r]*c[\t\n\r]*r[\t\n\r]*i[\t\n\r]*p[\t\n\r]*t[\t\n\r]*:/i;return t.test(e)}return false}}class T extends a.NodeFormatter{constructor(e={}){super({name:"spoiler",convert({node:e}){return r.Dom.create({tag:"details",attrs:{className:"ui-formatter__spoiler ui-icon-set__scope"},children:[r.Dom.create({tag:"summary",attrs:{className:"ui-formatter__spoiler-title"},text:e.getValue()})]})},after({element:e}){const[t,...a]=e.children;e.appendChild(t);e.appendChild(r.Dom.create({tag:"div",attrs:{className:"ui-formatter__spoiler-content"},children:[...a]}));return e},...e})}}class k extends a.NodeFormatter{constructor(e={}){super({name:"disk",convert({node:e,formatter:t,data:a}){const n=e.getAttribute("id");const o=a.files.find((e=>String(e.id)===String(n)));if(r.Type.isPlainObject(o)){var s;const e=o==null?void 0:(s=o.data)==null?void 0:s.file;if(r.Type.isPlainObject(e)){if(e.type.startsWith("image")){return r.Dom.create({tag:"div",attrs:{className:"ui-formatter-image"},children:[r.Dom.create({tag:"img",attrs:{src:t.makeSafeHref(e.downloadUrl)}})]})}if(e.type.startsWith("video")){return r.Dom.create({tag:"div",attrs:{className:"ui-formatter-video"},children:[r.Dom.create({tag:"video",attrs:{src:t.makeSafeHref(e.downloadUrl),controls:true}})]})}return r.Dom.create({tag:"a",attrs:{href:t.makeSafeHref(e.downloadUrl)},text:e.name})}}return null},...e})}}class D extends a.NodeFormatter{constructor(e){super({name:"user",convert({node:e,formatter:t}){var a;const n=t.getMentionSettings();if(r.Type.isStringFilled(n==null?void 0:(a=n.urlTemplate)==null?void 0:a.user)){const a=n.urlTemplate.user;const o=a.replaceAll("#ID#",e.getValue());return r.Dom.create({tag:"a",attrs:{className:"ui-formatter-link ui-formatter-mention",href:t.makeSafeHref(o),target:"_blank"}})}return r.Dom.create({tag:"span",attrs:{className:"ui-formatter-mention-stub"}})},...e})}}class L extends a.NodeFormatter{constructor(e={}){super({name:"department",convert({node:e,formatter:t}){var a;const n=t.getMentionSettings();if(r.Type.isStringFilled(n==null?void 0:(a=n.urlTemplate)==null?void 0:a.department)){const a=n.urlTemplate.department;const o=a.replaceAll("#ID#",e.getValue());return r.Dom.create({tag:"a",attrs:{className:"ui-formatter-link ui-formatter-mention",href:t.makeSafeHref(o),target:"_blank"}})}return r.Dom.create({tag:"span",attrs:{className:"ui-formatter-mention-stub"}})},...e})}}class C extends a.NodeFormatter{constructor(e={}){super({name:"project",convert({node:e,formatter:t}){var a;const n=t.getMentionSettings();if(r.Type.isStringFilled(n==null?void 0:(a=n.urlTemplate)==null?void 0:a.project)){const a=n.urlTemplate.project;const o=a.replaceAll("#group_id#",e.getValue());return r.Dom.create({tag:"a",attrs:{href:t.makeSafeHref(o),className:"ui-formatter-link ui-formatter-mention",target:"_blank"}})}return r.Dom.create({tag:"span",attrs:{className:"ui-formatter-mention-stub"}})},...e})}}var B=Object.freeze({RootNodeFormatter:n,TextNodeFormatter:o,TabNodeFormatter:s,LinebreakNodeFormatter:i,ParagraphNodeFormatter:c,BoldNodeFormatter:l,UnderlineNodeFormatter:m,ItalicNodeFormatter:d,StrikethroughNodeFormatter:u,SpanNodeFormatter:g,TableNodeFormatter:p,TableHeadCellNodeFormatter:f,TableDataCellNodeFormatter:h,TableRowNodeFormatter:F,ListNodeFormatter:b,ListItemNodeFormatter:N,QuoteNodeFormatter:S,CodeNodeFormatter:v,LinkNodeFormatter:x,SpoilerNodeFormatter:T,DiskNodeFormatter:k,UserNodeFormatter:D,DepartmentNodeFormatter:L,ProjectNodeFormatter:C});const A=r.Extension.getSettings("ui.bbcode.formatter.html-formatter");var y=babelHelpers.classPrivateFieldLooseKey("linkSettings");var w=babelHelpers.classPrivateFieldLooseKey("mentionSettings");class P extends a.Formatter{constructor(e={}){super({formatters:Object.values(B).map((e=>new e))});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,w,{writable:true,value:void 0});this.setNodeFormatters(e.formatters);this.setLinkSettings({...A.linkSettings,...e.linkSettings});this.setMentionSettings({...A.mention,...e.mention})}static decodeAmpersand(e){if(r.Type.isStringFilled(e)){return e.replaceAll(/&amp;/gi,"&")}return""}static decodeSquareBrackets(e){if(r.Type.isStringFilled(e)){return e.replaceAll(/&#91;/g,"[").replaceAll(/&#93;/g,"]")}return""}static stripFormFeedCharacter(e){if(r.Type.isStringFilled(e)){return e.replaceAll(/\f/gi,"")}return""}static encodeSingleQuotes(e){if(r.Type.isStringFilled(e)){return e.replaceAll("'","%27")}return""}static isAbsolutePath(e){return String(e).startsWith("/")}isHrefStartsWithAllowedScheme(e){return r.Type.isStringFilled(e)&&new RegExp(`/^${this.getLinkSettings().allowedSchemes}/`).test(e)}assignDefaultUrlScheme(e){if(r.Type.isStringFilled(e)){const t=this.getLinkSettings().defaultScheme;return`${t}://${e}`}return""}isShortLinkEnabled(){const{shortLink:e}=this.getLinkSettings();return r.Type.isPlainObject(e)&&e.enabled===true&&r.Type.isInteger(e.maxLength)}makeSafeHref(e){if(r.Type.isStringFilled(e)){let t=P.decodeAmpersand(e);t=P.decodeSquareBrackets(t);t=P.stripFormFeedCharacter(t);t=P.encodeSingleQuotes(t);if(!P.isAbsolutePath(t)&&!this.isHrefStartsWithAllowedScheme(t)){t=this.assignDefaultUrlScheme(t)}return t}return""}setLinkSettings(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y]={...e}}getLinkSettings(){return babelHelpers.classPrivateFieldLooseBase(this,y)[y]}setMentionSettings(e){babelHelpers.classPrivateFieldLooseBase(this,w)[w]={...e}}getMentionSettings(){return babelHelpers.classPrivateFieldLooseBase(this,w)[w]}getDefaultUnknownNodeCallback(e){return()=>new a.NodeFormatter({name:"unknown",before({node:e}){const t=e.getScheme();if(e.isVoid()){return t.createFragment({children:[t.createText(e.getOpeningTag())]})}return t.createFragment({children:[t.createText(e.getOpeningTag()),...e.getChildren(),t.createText(e.getClosingTag())]})},convert(){return document.createDocumentFragment()}})}}e.HtmlFormatter=P})(this.BX.UI.BBCode.Formatter=this.BX.UI.BBCode.Formatter||{},BX.UI.BBCode,BX,BX.UI.BBCode);
//# sourceMappingURL=html-formatter.bundle.map.js