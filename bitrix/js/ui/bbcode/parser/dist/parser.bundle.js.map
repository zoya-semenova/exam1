{"version":3,"file":"parser.bundle.js","sources":["../../shared/src/get-by-index.js","../src/parser-scheme.js","../src/parser.js"],"sourcesContent":["import { Type } from 'main.core';\n\nexport function getByIndex<T>(array: Array<T>, index: number): ?T\n{\n\tif (!Type.isArray(array))\n\t{\n\t\tthrow new TypeError('array is not a array');\n\t}\n\n\tif (!Type.isInteger(index))\n\t{\n\t\tthrow new TypeError('index is not a integer');\n\t}\n\n\tconst preparedIndex = index < 0 ? array.length + index : index;\n\n\treturn array[preparedIndex];\n};\n","import { BBCodeScheme, BBCodeTagScheme, BBCodeNode } from 'ui.bbcode.model';\nimport type { BBCodeContentNode } from 'ui.bbcode.model';\n\nexport class ParserScheme extends BBCodeScheme\n{\n\tgetTagScheme(tagName: string): BBCodeTagScheme\n\t{\n\t\tif (tagName === 'code')\n\t\t{\n\t\t\treturn new BBCodeTagScheme({\n\t\t\t\tname: 'code',\n\t\t\t\tconvertChild: (child: BBCodeContentNode, scheme: BBCodeScheme): BBCodeContentNode => {\n\t\t\t\t\tif (['#linebreak', '#tab', '#text'].includes(child.getName()))\n\t\t\t\t\t{\n\t\t\t\t\t\treturn child;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn scheme.createText(child.toString());\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn new BBCodeTagScheme({\n\t\t\tname: 'any',\n\t\t});\n\t}\n\n\tisAllowedTag(tagName: string): boolean\n\t{\n\t\treturn true;\n\t}\n\n\tisChildAllowed(parent: string | BBCodeNode, child: string | BBCodeNode): boolean\n\t{\n\t\treturn true;\n\t}\n}\n","import { Type } from 'main.core';\nimport { getByIndex } from '../../shared';\nimport {\n\tBBCodeScheme,\n\tDefaultBBCodeScheme,\n\tBBCodeNode,\n\ttypeof BBCodeRootNode,\n\ttypeof BBCodeElementNode,\n\ttypeof BBCodeTextNode,\n\ttypeof BBCodeTagScheme,\n\ttype BBCodeContentNode,\n\ttype BBCodeSpecialCharNode,\n} from 'ui.bbcode.model';\nimport { BBCodeEncoder } from 'ui.bbcode.encoder';\nimport { ParserScheme } from './parser-scheme';\n\nconst TAG_REGEX: RegExp = /\\[(\\/)?(\\w+|\\*)(.*?)]/gs;\nconst isSpecialChar = (symbol: string): boolean => {\n\treturn ['\\n', '\\t'].includes(symbol);\n};\n\nconst isList = (tagName: string): boolean => {\n\treturn ['list', 'ul', 'ol'].includes(String(tagName).toLowerCase());\n};\n\nconst isListItem = (tagName: string): boolean => {\n\treturn ['*', 'li'].includes(String(tagName).toLowerCase());\n};\n\nconst parserScheme = new ParserScheme();\n\ntype BBCodeParserOptions = {\n\tscheme?: BBCodeScheme,\n\tonUnknown?: (node: BBCodeContentNode, scheme: BBCodeScheme) => void,\n\tencoder?: BBCodeEncoder,\n};\n\nclass BBCodeParser\n{\n\tscheme: BBCodeScheme;\n\tencoder: BBCodeEncoder;\n\tonUnknownHandler: () => any;\n\n\tconstructor(options: BBCodeParserOptions = {})\n\t{\n\t\tif (options.scheme)\n\t\t{\n\t\t\tthis.setScheme(options.scheme);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setScheme(new DefaultBBCodeScheme());\n\t\t}\n\n\t\tif (Type.isFunction(options.onUnknown))\n\t\t{\n\t\t\tthis.setOnUnknown(options.onUnknown);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setOnUnknown(BBCodeParser.defaultOnUnknownHandler);\n\t\t}\n\n\t\tif (options.encoder instanceof BBCodeEncoder)\n\t\t{\n\t\t\tthis.setEncoder(options.encoder);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setEncoder(new BBCodeEncoder());\n\t\t}\n\t}\n\n\tsetScheme(scheme: BBCodeScheme)\n\t{\n\t\tthis.scheme = scheme;\n\t}\n\n\tgetScheme(): BBCodeScheme\n\t{\n\t\treturn this.scheme;\n\t}\n\n\tsetOnUnknown(handler: () => any)\n\t{\n\t\tif (!Type.isFunction(handler))\n\t\t{\n\t\t\tthrow new TypeError('handler is not a function');\n\t\t}\n\n\t\tthis.onUnknownHandler = handler;\n\t}\n\n\tgetOnUnknownHandler(): () => any\n\t{\n\t\treturn this.onUnknownHandler;\n\t}\n\n\tsetEncoder(encoder: BBCodeEncoder)\n\t{\n\t\tif (encoder instanceof BBCodeEncoder)\n\t\t{\n\t\t\tthis.encoder = encoder;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthrow new TypeError('encoder is not BBCodeEncoder instance');\n\t\t}\n\t}\n\n\tgetEncoder(): BBCodeEncoder\n\t{\n\t\treturn this.encoder;\n\t}\n\n\tstatic defaultOnUnknownHandler(node: BBCodeContentNode, scheme: BBCodeScheme): ?Array<BBCodeContentNode>\n\t{\n\t\tif (node.getType() === BBCodeNode.ELEMENT_NODE)\n\t\t{\n\t\t\tconst nodeName: string = node.getName();\n\t\t\tif (['left', 'center', 'right', 'justify'].includes(nodeName))\n\t\t\t{\n\t\t\t\tnode.replace(\n\t\t\t\t\tscheme.createElement({\n\t\t\t\t\t\tname: 'p',\n\t\t\t\t\t\tchildren: node.getChildren(),\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if (['background', 'color', 'size'].includes(nodeName))\n\t\t\t{\n\t\t\t\tnode.replace(\n\t\t\t\t\tscheme.createElement({\n\t\t\t\t\t\tname: 'b',\n\t\t\t\t\t\tchildren: node.getChildren(),\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconst openingTag: string = node.getOpeningTag();\n\t\t\t\tconst closingTag: string = node.getClosingTag();\n\n\t\t\t\tnode.replace(\n\t\t\t\t\tscheme.createText(openingTag),\n\t\t\t\t\t...node.getChildren(),\n\t\t\t\t\tscheme.createText(closingTag),\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic toLowerCase(value: string): string\n\t{\n\t\tif (Type.isStringFilled(value))\n\t\t{\n\t\t\treturn value.toLowerCase();\n\t\t}\n\n\t\treturn value;\n\t}\n\n\tparseText(text: string): Array<BBCodeTextNode | BBCodeSpecialCharNode>\n\t{\n\t\tif (Type.isStringFilled(text))\n\t\t{\n\t\t\treturn [...text]\n\t\t\t\t.reduce((acc: Array<BBCodeTextNode | BBCodeSpecialCharNode>, symbol: string) => {\n\t\t\t\t\tif (isSpecialChar(symbol))\n\t\t\t\t\t{\n\t\t\t\t\t\tacc.push(symbol);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tconst lastItem: string = getByIndex(acc, -1);\n\t\t\t\t\t\tif (isSpecialChar(lastItem) || Type.isNil(lastItem))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tacc.push(symbol);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tacc[acc.length - 1] += symbol;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn acc;\n\t\t\t\t}, [])\n\t\t\t\t.map((fragment: string) => {\n\t\t\t\t\tif (fragment === '\\n')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn parserScheme.createNewLine();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (fragment === '\\t')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn parserScheme.createTab();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn parserScheme.createText({\n\t\t\t\t\t\tcontent: this.getEncoder().decodeText(fragment),\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tstatic findNextTagIndex(bbcode: string, startIndex = 0): number\n\t{\n\t\tconst nextContent: string = bbcode.slice(startIndex);\n\t\tconst [nextTag: ?string] = nextContent.match(new RegExp(TAG_REGEX)) || [];\n\t\tif (nextTag)\n\t\t{\n\t\t\treturn bbcode.indexOf(nextTag, startIndex);\n\t\t}\n\n\t\treturn -1;\n\t}\n\n\tstatic trimQuotes(value: string): string\n\t{\n\t\tconst source = String(value);\n\t\tif ((/^[\"'].*[\"']$/g).test(source))\n\t\t{\n\t\t\treturn source.slice(1, -1);\n\t\t}\n\n\t\treturn value;\n\t}\n\n\tparseAttributes(sourceAttributes: string): { value: ?string, attributes: Array<[string, string]> }\n\t{\n\t\tconst result: {value: string, attributes: Array<Array<string, string>>} = { value: '', attributes: [] };\n\n\t\tif (Type.isStringFilled(sourceAttributes))\n\t\t{\n\t\t\tif (sourceAttributes.startsWith('='))\n\t\t\t{\n\t\t\t\tresult.value = this.getEncoder().decodeAttribute(\n\t\t\t\t\tBBCodeParser.trimQuotes(\n\t\t\t\t\t\tsourceAttributes.slice(1),\n\t\t\t\t\t),\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn sourceAttributes\n\t\t\t\t.trim()\n\t\t\t\t.split(' ')\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.reduce((acc: typeof result, item: string) => {\n\t\t\t\t\tconst [key: string, value: string = ''] = item.split('=');\n\t\t\t\t\tacc.attributes.push([\n\t\t\t\t\t\tBBCodeParser.toLowerCase(key),\n\t\t\t\t\t\tthis.getEncoder().decodeAttribute(\n\t\t\t\t\t\t\tBBCodeParser.trimQuotes(value),\n\t\t\t\t\t\t),\n\t\t\t\t\t]);\n\n\t\t\t\t\treturn acc;\n\t\t\t\t}, result);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tparse(bbcode: string): BBCodeRootNode\n\t{\n\t\tconst result: BBCodeRootNode = parserScheme.createRoot();\n\n\t\tconst firstTagIndex: number = BBCodeParser.findNextTagIndex(bbcode);\n\t\tif (firstTagIndex !== 0)\n\t\t{\n\t\t\tconst textBeforeFirstTag: string = firstTagIndex === -1 ? bbcode : bbcode.slice(0, firstTagIndex);\n\t\t\tresult.appendChild(\n\t\t\t\t...this.parseText(textBeforeFirstTag),\n\t\t\t);\n\t\t}\n\n\t\tconst stack: Array<BBCodeElementNode> = [result];\n\t\tconst wasOpened: Array<string> = [];\n\t\tlet current: ?BBCodeElementNode = null;\n\t\tlet level: number = 0;\n\n\t\tbbcode.replace(TAG_REGEX, (fullTag: string, slash: ?string, tagName: string, attrs: ?string, index: number) => {\n\t\t\tconst isOpeningTag: boolean = Boolean(slash) === false;\n\t\t\tconst startIndex: number = fullTag.length + index;\n\t\t\tconst nextContent: string = bbcode.slice(startIndex);\n\t\t\tconst attributes = this.parseAttributes(attrs);\n\t\t\tconst lowerCaseTagName: string = BBCodeParser.toLowerCase(tagName);\n\t\t\tlet parent: ?(BBCodeRootNode | BBCodeElementNode) = stack[level];\n\n\t\t\tif (isOpeningTag)\n\t\t\t{\n\t\t\t\tconst isPotentiallyVoid: boolean = !nextContent.includes(`[/${tagName}]`);\n\t\t\t\tif (\n\t\t\t\t\tisPotentiallyVoid\n\t\t\t\t\t&& !isListItem(lowerCaseTagName)\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tconst tagScheme: BBCodeTagScheme = this.getScheme().getTagScheme(lowerCaseTagName);\n\t\t\t\t\tconst isAllowedVoidTag: boolean = tagScheme && tagScheme.isVoid();\n\t\t\t\t\tif (isAllowedVoidTag)\n\t\t\t\t\t{\n\t\t\t\t\t\tcurrent = parserScheme.createElement({\n\t\t\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t\t\t\tvalue: attributes.value,\n\t\t\t\t\t\t\tattributes: Object.fromEntries(attributes.attributes),\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcurrent.setScheme(this.getScheme());\n\t\t\t\t\t\tparent.appendChild(current);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tparent.appendChild(\n\t\t\t\t\t\t\tparserScheme.createText(fullTag),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst nextTagIndex: number = BBCodeParser.findNextTagIndex(bbcode, startIndex);\n\t\t\t\t\tif (nextTagIndex !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst content: string = nextTagIndex === -1 ? nextContent : bbcode.slice(startIndex, nextTagIndex);\n\t\t\t\t\t\tparent.appendChild(\n\t\t\t\t\t\t\t...this.parseText(content),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (isListItem(lowerCaseTagName) && current && isListItem(current.getName()))\n\t\t\t\t\t{\n\t\t\t\t\t\tlevel--;\n\t\t\t\t\t\tparent = stack[level];\n\t\t\t\t\t}\n\n\t\t\t\t\tcurrent = parserScheme.createElement({\n\t\t\t\t\t\tname: lowerCaseTagName,\n\t\t\t\t\t\tvalue: attributes.value,\n\t\t\t\t\t\tattributes: Object.fromEntries(attributes.attributes),\n\t\t\t\t\t});\n\n\t\t\t\t\tconst nextTagIndex: number = BBCodeParser.findNextTagIndex(bbcode, startIndex);\n\t\t\t\t\tif (nextTagIndex !== 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst content: string = nextTagIndex === -1 ? nextContent : bbcode.slice(startIndex, nextTagIndex);\n\t\t\t\t\t\tcurrent.appendChild(\n\t\t\t\t\t\t\t...this.parseText(content),\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tparent.appendChild(current);\n\n\t\t\t\t\tlevel++;\n\t\t\t\t\tstack[level] = current;\n\t\t\t\t\twasOpened.push(lowerCaseTagName);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (wasOpened.includes(lowerCaseTagName))\n\t\t\t\t{\n\t\t\t\t\tlevel--;\n\t\t\t\t\tconst openedTagIndex: number = wasOpened.indexOf(lowerCaseTagName);\n\t\t\t\t\twasOpened.splice(openedTagIndex, 1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tstack[level].appendChild(\n\t\t\t\t\t\tparserScheme.createText(fullTag),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (isList(lowerCaseTagName) && level > 0)\n\t\t\t\t{\n\t\t\t\t\tlevel--;\n\t\t\t\t}\n\n\t\t\t\tconst nextTagIndex: number = BBCodeParser.findNextTagIndex(bbcode, startIndex);\n\t\t\t\tif (nextTagIndex !== 0 && stack[level])\n\t\t\t\t{\n\t\t\t\t\tconst content: string = nextTagIndex === -1 ? nextContent : bbcode.slice(startIndex, nextTagIndex);\n\t\t\t\t\tstack[level].appendChild(\n\t\t\t\t\t\t...this.parseText(content),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (isListItem(stack[level].getName()) && level > 0)\n\t\t\t\t{\n\t\t\t\t\tlevel--;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tconst getFinalLineBreaksIndexes = (node: BBCodeContentNode) => {\n\t\t\tlet skip = false;\n\n\t\t\treturn node\n\t\t\t\t.getChildren()\n\t\t\t\t.reduceRight((acc: Array<BBCodeContentNode>, child: BBCodeContentNode, index: number) => {\n\t\t\t\t\tif (!skip && child.getName() === '#linebreak')\n\t\t\t\t\t{\n\t\t\t\t\t\tacc.push(index);\n\t\t\t\t\t}\n\t\t\t\t\telse if (!skip && child.getName() !== '#tab')\n\t\t\t\t\t{\n\t\t\t\t\t\tskip = true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn acc;\n\t\t\t\t}, []);\n\t\t};\n\n\t\tBBCodeNode.flattenAst(result).forEach((node: BBCodeContentNode) => {\n\t\t\tif (node.getName() === '*')\n\t\t\t{\n\t\t\t\tconst finalLinebreaksIndexes: Array<number> = getFinalLineBreaksIndexes(node);\n\t\t\t\tif (finalLinebreaksIndexes.length === 1)\n\t\t\t\t{\n\t\t\t\t\tnode.setChildren(\n\t\t\t\t\t\tnode.getChildren().slice(0, getByIndex(finalLinebreaksIndexes, 0)),\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (finalLinebreaksIndexes.length > 1 && (finalLinebreaksIndexes & 2) === 0)\n\t\t\t\t{\n\t\t\t\t\tnode.setChildren(\n\t\t\t\t\t\tnode.getChildren().slice(0, getByIndex(finalLinebreaksIndexes, 0)),\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tresult.setScheme(\n\t\t\tthis.getScheme(),\n\t\t\tthis.getOnUnknownHandler(),\n\t\t);\n\n\t\treturn result;\n\t}\n}\n\nexport {\n\tBBCodeParser,\n};\n"],"names":["getByIndex","array","index","Type","isArray","TypeError","isInteger","preparedIndex","length","ParserScheme","BBCodeScheme","getTagScheme","tagName","BBCodeTagScheme","name","convertChild","child","scheme","includes","getName","createText","toString","isAllowedTag","isChildAllowed","parent","TAG_REGEX","isSpecialChar","symbol","isList","String","toLowerCase","isListItem","parserScheme","BBCodeParser","constructor","options","setScheme","DefaultBBCodeScheme","isFunction","onUnknown","setOnUnknown","defaultOnUnknownHandler","encoder","BBCodeEncoder","setEncoder","getScheme","handler","onUnknownHandler","getOnUnknownHandler","getEncoder","node","getType","BBCodeNode","ELEMENT_NODE","nodeName","replace","createElement","children","getChildren","openingTag","getOpeningTag","closingTag","getClosingTag","value","isStringFilled","parseText","text","reduce","acc","push","lastItem","isNil","map","fragment","createNewLine","createTab","content","decodeText","findNextTagIndex","bbcode","startIndex","nextContent","slice","nextTag","match","RegExp","indexOf","trimQuotes","source","test","parseAttributes","sourceAttributes","result","attributes","startsWith","decodeAttribute","trim","split","filter","Boolean","item","key","parse","createRoot","firstTagIndex","textBeforeFirstTag","appendChild","stack","wasOpened","current","level","fullTag","slash","attrs","isOpeningTag","lowerCaseTagName","isPotentiallyVoid","tagScheme","isAllowedVoidTag","isVoid","Object","fromEntries","nextTagIndex","openedTagIndex","splice","getFinalLineBreaksIndexes","skip","reduceRight","flattenAst","forEach","finalLinebreaksIndexes","setChildren"],"mappings":";;;;;;CAEO,SAASA,UAAU,CAAIC,KAAe,EAAEC,KAAa,EAC5D;GACC,IAAI,CAACC,cAAI,CAACC,OAAO,CAACH,KAAK,CAAC,EACxB;KACC,MAAM,IAAII,SAAS,CAAC,sBAAsB,CAAC;;GAG5C,IAAI,CAACF,cAAI,CAACG,SAAS,CAACJ,KAAK,CAAC,EAC1B;KACC,MAAM,IAAIG,SAAS,CAAC,wBAAwB,CAAC;;GAG9C,MAAME,aAAa,GAAGL,KAAK,GAAG,CAAC,GAAGD,KAAK,CAACO,MAAM,GAAGN,KAAK,GAAGA,KAAK;GAE9D,OAAOD,KAAK,CAACM,aAAa,CAAC;CAC5B;;CCdO,MAAME,YAAY,SAASC,4BAAY,CAC9C;GACCC,YAAY,CAACC,OAAe,EAC5B;KACC,IAAIA,OAAO,KAAK,MAAM,EACtB;OACC,OAAO,IAAIC,+BAAe,CAAC;SAC1BC,IAAI,EAAE,MAAM;SACZC,YAAY,EAAE,CAACC,KAAwB,EAAEC,MAAoB,KAAwB;WACpF,IAAI,CAAC,YAAY,EAAE,MAAM,EAAE,OAAO,CAAC,CAACC,QAAQ,CAACF,KAAK,CAACG,OAAO,EAAE,CAAC,EAC7D;aACC,OAAOH,KAAK;;WAGb,OAAOC,MAAM,CAACG,UAAU,CAACJ,KAAK,CAACK,QAAQ,EAAE,CAAC;;QAE3C,CAAC;;KAGH,OAAO,IAAIR,+BAAe,CAAC;OAC1BC,IAAI,EAAE;MACN,CAAC;;GAGHQ,YAAY,CAACV,OAAe,EAC5B;KACC,OAAO,IAAI;;GAGZW,cAAc,CAACC,MAA2B,EAAER,KAA0B,EACtE;KACC,OAAO,IAAI;;CAEb;;CCpBA,MAAMS,SAAiB,GAAG,yBAAyB;CACnD,MAAMC,aAAa,GAAIC,MAAc,IAAc;GAClD,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,CAACT,QAAQ,CAACS,MAAM,CAAC;CACrC,CAAC;CAED,MAAMC,MAAM,GAAIhB,OAAe,IAAc;GAC5C,OAAO,CAAC,MAAM,EAAE,IAAI,EAAE,IAAI,CAAC,CAACM,QAAQ,CAACW,MAAM,CAACjB,OAAO,CAAC,CAACkB,WAAW,EAAE,CAAC;CACpE,CAAC;CAED,MAAMC,UAAU,GAAInB,OAAe,IAAc;GAChD,OAAO,CAAC,GAAG,EAAE,IAAI,CAAC,CAACM,QAAQ,CAACW,MAAM,CAACjB,OAAO,CAAC,CAACkB,WAAW,EAAE,CAAC;CAC3D,CAAC;CAED,MAAME,YAAY,GAAG,IAAIvB,YAAY,EAAE;CAQvC,MAAMwB,YAAY,CAClB;GAKCC,WAAW,CAACC,OAA4B,GAAG,EAAE,EAC7C;KACC,IAAIA,OAAO,CAAClB,MAAM,EAClB;OACC,IAAI,CAACmB,SAAS,CAACD,OAAO,CAAClB,MAAM,CAAC;MAC9B,MAED;OACC,IAAI,CAACmB,SAAS,CAAC,IAAIC,mCAAmB,EAAE,CAAC;;KAG1C,IAAIlC,cAAI,CAACmC,UAAU,CAACH,OAAO,CAACI,SAAS,CAAC,EACtC;OACC,IAAI,CAACC,YAAY,CAACL,OAAO,CAACI,SAAS,CAAC;MACpC,MAED;OACC,IAAI,CAACC,YAAY,CAACP,YAAY,CAACQ,uBAAuB,CAAC;;KAGxD,IAAIN,OAAO,CAACO,OAAO,YAAYC,+BAAa,EAC5C;OACC,IAAI,CAACC,UAAU,CAACT,OAAO,CAACO,OAAO,CAAC;MAChC,MAED;OACC,IAAI,CAACE,UAAU,CAAC,IAAID,+BAAa,EAAE,CAAC;;;GAItCP,SAAS,CAACnB,MAAoB,EAC9B;KACC,IAAI,CAACA,MAAM,GAAGA,MAAM;;GAGrB4B,SAAS,GACT;KACC,OAAO,IAAI,CAAC5B,MAAM;;GAGnBuB,YAAY,CAACM,OAAkB,EAC/B;KACC,IAAI,CAAC3C,cAAI,CAACmC,UAAU,CAACQ,OAAO,CAAC,EAC7B;OACC,MAAM,IAAIzC,SAAS,CAAC,2BAA2B,CAAC;;KAGjD,IAAI,CAAC0C,gBAAgB,GAAGD,OAAO;;GAGhCE,mBAAmB,GACnB;KACC,OAAO,IAAI,CAACD,gBAAgB;;GAG7BH,UAAU,CAACF,OAAsB,EACjC;KACC,IAAIA,OAAO,YAAYC,+BAAa,EACpC;OACC,IAAI,CAACD,OAAO,GAAGA,OAAO;MACtB,MAED;OACC,MAAM,IAAIrC,SAAS,CAAC,uCAAuC,CAAC;;;GAI9D4C,UAAU,GACV;KACC,OAAO,IAAI,CAACP,OAAO;;GAGpB,OAAOD,uBAAuB,CAACS,IAAuB,EAAEjC,MAAoB,EAC5E;KACC,IAAIiC,IAAI,CAACC,OAAO,EAAE,KAAKC,0BAAU,CAACC,YAAY,EAC9C;OACC,MAAMC,QAAgB,GAAGJ,IAAI,CAAC/B,OAAO,EAAE;OACvC,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC,CAACD,QAAQ,CAACoC,QAAQ,CAAC,EAC7D;SACCJ,IAAI,CAACK,OAAO,CACXtC,MAAM,CAACuC,aAAa,CAAC;WACpB1C,IAAI,EAAE,GAAG;WACT2C,QAAQ,EAAEP,IAAI,CAACQ,WAAW;UAC1B,CAAC,CACF;QACD,MACI,IAAI,CAAC,YAAY,EAAE,OAAO,EAAE,MAAM,CAAC,CAACxC,QAAQ,CAACoC,QAAQ,CAAC,EAC3D;SACCJ,IAAI,CAACK,OAAO,CACXtC,MAAM,CAACuC,aAAa,CAAC;WACpB1C,IAAI,EAAE,GAAG;WACT2C,QAAQ,EAAEP,IAAI,CAACQ,WAAW;UAC1B,CAAC,CACF;QACD,MAED;SACC,MAAMC,UAAkB,GAAGT,IAAI,CAACU,aAAa,EAAE;SAC/C,MAAMC,UAAkB,GAAGX,IAAI,CAACY,aAAa,EAAE;SAE/CZ,IAAI,CAACK,OAAO,CACXtC,MAAM,CAACG,UAAU,CAACuC,UAAU,CAAC,EAC7B,GAAGT,IAAI,CAACQ,WAAW,EAAE,EACrBzC,MAAM,CAACG,UAAU,CAACyC,UAAU,CAAC,CAC7B;;;;GAKJ,OAAO/B,WAAW,CAACiC,KAAa,EAChC;KACC,IAAI5D,cAAI,CAAC6D,cAAc,CAACD,KAAK,CAAC,EAC9B;OACC,OAAOA,KAAK,CAACjC,WAAW,EAAE;;KAG3B,OAAOiC,KAAK;;GAGbE,SAAS,CAACC,IAAY,EACtB;KACC,IAAI/D,cAAI,CAAC6D,cAAc,CAACE,IAAI,CAAC,EAC7B;OACC,OAAO,CAAC,GAAGA,IAAI,CAAC,CACdC,MAAM,CAAC,CAACC,GAAkD,EAAEzC,MAAc,KAAK;SAC/E,IAAID,aAAa,CAACC,MAAM,CAAC,EACzB;WACCyC,GAAG,CAACC,IAAI,CAAC1C,MAAM,CAAC;UAChB,MAED;WACC,MAAM2C,QAAgB,GAAGtE,UAAU,CAACoE,GAAG,EAAE,CAAC,CAAC,CAAC;WAC5C,IAAI1C,aAAa,CAAC4C,QAAQ,CAAC,IAAInE,cAAI,CAACoE,KAAK,CAACD,QAAQ,CAAC,EACnD;aACCF,GAAG,CAACC,IAAI,CAAC1C,MAAM,CAAC;YAChB,MAED;aACCyC,GAAG,CAACA,GAAG,CAAC5D,MAAM,GAAG,CAAC,CAAC,IAAImB,MAAM;;;SAI/B,OAAOyC,GAAG;QACV,EAAE,EAAE,CAAC,CACLI,GAAG,CAAEC,QAAgB,IAAK;SAC1B,IAAIA,QAAQ,KAAK,IAAI,EACrB;WACC,OAAOzC,YAAY,CAAC0C,aAAa,EAAE;;SAGpC,IAAID,QAAQ,KAAK,IAAI,EACrB;WACC,OAAOzC,YAAY,CAAC2C,SAAS,EAAE;;SAGhC,OAAO3C,YAAY,CAACZ,UAAU,CAAC;WAC9BwD,OAAO,EAAE,IAAI,CAAC3B,UAAU,EAAE,CAAC4B,UAAU,CAACJ,QAAQ;UAC9C,CAAC;QACF,CAAC;;KAGJ,OAAO,EAAE;;GAGV,OAAOK,gBAAgB,CAACC,MAAc,EAAEC,UAAU,GAAG,CAAC,EACtD;KACC,MAAMC,WAAmB,GAAGF,MAAM,CAACG,KAAK,CAACF,UAAU,CAAC;KACpD,MAAM,CAACG,OAAgB,CAAC,GAAGF,WAAW,CAACG,KAAK,CAAC,IAAIC,MAAM,CAAC5D,SAAS,CAAC,CAAC,IAAI,EAAE;KACzE,IAAI0D,OAAO,EACX;OACC,OAAOJ,MAAM,CAACO,OAAO,CAACH,OAAO,EAAEH,UAAU,CAAC;;KAG3C,OAAO,CAAC,CAAC;;GAGV,OAAOO,UAAU,CAACxB,KAAa,EAC/B;KACC,MAAMyB,MAAM,GAAG3D,MAAM,CAACkC,KAAK,CAAC;KAC5B,IAAK,eAAe,CAAE0B,IAAI,CAACD,MAAM,CAAC,EAClC;OACC,OAAOA,MAAM,CAACN,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;;KAG3B,OAAOnB,KAAK;;GAGb2B,eAAe,CAACC,gBAAwB,EACxC;KACC,MAAMC,MAAiE,GAAG;OAAE7B,KAAK,EAAE,EAAE;OAAE8B,UAAU,EAAE;MAAI;KAEvG,IAAI1F,cAAI,CAAC6D,cAAc,CAAC2B,gBAAgB,CAAC,EACzC;OACC,IAAIA,gBAAgB,CAACG,UAAU,CAAC,GAAG,CAAC,EACpC;SACCF,MAAM,CAAC7B,KAAK,GAAG,IAAI,CAACd,UAAU,EAAE,CAAC8C,eAAe,CAC/C9D,YAAY,CAACsD,UAAU,CACtBI,gBAAgB,CAACT,KAAK,CAAC,CAAC,CAAC,CACzB,CACD;SAED,OAAOU,MAAM;;OAGd,OAAOD,gBAAgB,CACrBK,IAAI,EAAE,CACNC,KAAK,CAAC,GAAG,CAAC,CACVC,MAAM,CAACC,OAAO,CAAC,CACfhC,MAAM,CAAC,CAACC,GAAkB,EAAEgC,IAAY,KAAK;SAC7C,MAAM,CAACC,GAAW,EAAEtC,KAAa,GAAG,EAAE,CAAC,GAAGqC,IAAI,CAACH,KAAK,CAAC,GAAG,CAAC;SACzD7B,GAAG,CAACyB,UAAU,CAACxB,IAAI,CAAC,CACnBpC,YAAY,CAACH,WAAW,CAACuE,GAAG,CAAC,EAC7B,IAAI,CAACpD,UAAU,EAAE,CAAC8C,eAAe,CAChC9D,YAAY,CAACsD,UAAU,CAACxB,KAAK,CAAC,CAC9B,CACD,CAAC;SAEF,OAAOK,GAAG;QACV,EAAEwB,MAAM,CAAC;;KAGZ,OAAOA,MAAM;;GAGdU,KAAK,CAACvB,MAAc,EACpB;KACC,MAAMa,MAAsB,GAAG5D,YAAY,CAACuE,UAAU,EAAE;KAExD,MAAMC,aAAqB,GAAGvE,YAAY,CAAC6C,gBAAgB,CAACC,MAAM,CAAC;KACnE,IAAIyB,aAAa,KAAK,CAAC,EACvB;OACC,MAAMC,kBAA0B,GAAGD,aAAa,KAAK,CAAC,CAAC,GAAGzB,MAAM,GAAGA,MAAM,CAACG,KAAK,CAAC,CAAC,EAAEsB,aAAa,CAAC;OACjGZ,MAAM,CAACc,WAAW,CACjB,GAAG,IAAI,CAACzC,SAAS,CAACwC,kBAAkB,CAAC,CACrC;;KAGF,MAAME,KAA+B,GAAG,CAACf,MAAM,CAAC;KAChD,MAAMgB,SAAwB,GAAG,EAAE;KACnC,IAAIC,OAA2B,GAAG,IAAI;KACtC,IAAIC,KAAa,GAAG,CAAC;KAErB/B,MAAM,CAACxB,OAAO,CAAC9B,SAAS,EAAE,CAACsF,OAAe,EAAEC,KAAc,EAAEpG,OAAe,EAAEqG,KAAc,EAAE/G,KAAa,KAAK;OAC9G,MAAMgH,YAAqB,GAAGf,OAAO,CAACa,KAAK,CAAC,KAAK,KAAK;OACtD,MAAMhC,UAAkB,GAAG+B,OAAO,CAACvG,MAAM,GAAGN,KAAK;OACjD,MAAM+E,WAAmB,GAAGF,MAAM,CAACG,KAAK,CAACF,UAAU,CAAC;OACpD,MAAMa,UAAU,GAAG,IAAI,CAACH,eAAe,CAACuB,KAAK,CAAC;OAC9C,MAAME,gBAAwB,GAAGlF,YAAY,CAACH,WAAW,CAAClB,OAAO,CAAC;OAClE,IAAIY,MAA6C,GAAGmF,KAAK,CAACG,KAAK,CAAC;OAEhE,IAAII,YAAY,EAChB;SACC,MAAME,iBAA0B,GAAG,CAACnC,WAAW,CAAC/D,QAAQ,CAAE,KAAIN,OAAQ,GAAE,CAAC;SACzE,IACCwG,iBAAiB,IACd,CAACrF,UAAU,CAACoF,gBAAgB,CAAC,EAEjC;WACC,MAAME,SAA0B,GAAG,IAAI,CAACxE,SAAS,EAAE,CAAClC,YAAY,CAACwG,gBAAgB,CAAC;WAClF,MAAMG,gBAAyB,GAAGD,SAAS,IAAIA,SAAS,CAACE,MAAM,EAAE;WACjE,IAAID,gBAAgB,EACpB;aACCT,OAAO,GAAG7E,YAAY,CAACwB,aAAa,CAAC;eACpC1C,IAAI,EAAEqG,gBAAgB;eACtBpD,KAAK,EAAE8B,UAAU,CAAC9B,KAAK;eACvB8B,UAAU,EAAE2B,MAAM,CAACC,WAAW,CAAC5B,UAAU,CAACA,UAAU;cACpD,CAAC;aAEFgB,OAAO,CAACzE,SAAS,CAAC,IAAI,CAACS,SAAS,EAAE,CAAC;aACnCrB,MAAM,CAACkF,WAAW,CAACG,OAAO,CAAC;YAC3B,MAED;aACCrF,MAAM,CAACkF,WAAW,CACjB1E,YAAY,CAACZ,UAAU,CAAC2F,OAAO,CAAC,CAChC;;WAGF,MAAMW,YAAoB,GAAGzF,YAAY,CAAC6C,gBAAgB,CAACC,MAAM,EAAEC,UAAU,CAAC;WAC9E,IAAI0C,YAAY,KAAK,CAAC,EACtB;aACC,MAAM9C,OAAe,GAAG8C,YAAY,KAAK,CAAC,CAAC,GAAGzC,WAAW,GAAGF,MAAM,CAACG,KAAK,CAACF,UAAU,EAAE0C,YAAY,CAAC;aAClGlG,MAAM,CAACkF,WAAW,CACjB,GAAG,IAAI,CAACzC,SAAS,CAACW,OAAO,CAAC,CAC1B;;UAEF,MAED;WACC,IAAI7C,UAAU,CAACoF,gBAAgB,CAAC,IAAIN,OAAO,IAAI9E,UAAU,CAAC8E,OAAO,CAAC1F,OAAO,EAAE,CAAC,EAC5E;aACC2F,KAAK,EAAE;aACPtF,MAAM,GAAGmF,KAAK,CAACG,KAAK,CAAC;;WAGtBD,OAAO,GAAG7E,YAAY,CAACwB,aAAa,CAAC;aACpC1C,IAAI,EAAEqG,gBAAgB;aACtBpD,KAAK,EAAE8B,UAAU,CAAC9B,KAAK;aACvB8B,UAAU,EAAE2B,MAAM,CAACC,WAAW,CAAC5B,UAAU,CAACA,UAAU;YACpD,CAAC;WAEF,MAAM6B,YAAoB,GAAGzF,YAAY,CAAC6C,gBAAgB,CAACC,MAAM,EAAEC,UAAU,CAAC;WAC9E,IAAI0C,YAAY,KAAK,CAAC,EACtB;aACC,MAAM9C,OAAe,GAAG8C,YAAY,KAAK,CAAC,CAAC,GAAGzC,WAAW,GAAGF,MAAM,CAACG,KAAK,CAACF,UAAU,EAAE0C,YAAY,CAAC;aAClGb,OAAO,CAACH,WAAW,CAClB,GAAG,IAAI,CAACzC,SAAS,CAACW,OAAO,CAAC,CAC1B;;WAGFpD,MAAM,CAACkF,WAAW,CAACG,OAAO,CAAC;WAE3BC,KAAK,EAAE;WACPH,KAAK,CAACG,KAAK,CAAC,GAAGD,OAAO;WACtBD,SAAS,CAACvC,IAAI,CAAC8C,gBAAgB,CAAC;;QAEjC,MAED;SACC,IAAIP,SAAS,CAAC1F,QAAQ,CAACiG,gBAAgB,CAAC,EACxC;WACCL,KAAK,EAAE;WACP,MAAMa,cAAsB,GAAGf,SAAS,CAACtB,OAAO,CAAC6B,gBAAgB,CAAC;WAClEP,SAAS,CAACgB,MAAM,CAACD,cAAc,EAAE,CAAC,CAAC;UACnC,MAED;WACChB,KAAK,CAACG,KAAK,CAAC,CAACJ,WAAW,CACvB1E,YAAY,CAACZ,UAAU,CAAC2F,OAAO,CAAC,CAChC;;SAGF,IAAInF,MAAM,CAACuF,gBAAgB,CAAC,IAAIL,KAAK,GAAG,CAAC,EACzC;WACCA,KAAK,EAAE;;SAGR,MAAMY,YAAoB,GAAGzF,YAAY,CAAC6C,gBAAgB,CAACC,MAAM,EAAEC,UAAU,CAAC;SAC9E,IAAI0C,YAAY,KAAK,CAAC,IAAIf,KAAK,CAACG,KAAK,CAAC,EACtC;WACC,MAAMlC,OAAe,GAAG8C,YAAY,KAAK,CAAC,CAAC,GAAGzC,WAAW,GAAGF,MAAM,CAACG,KAAK,CAACF,UAAU,EAAE0C,YAAY,CAAC;WAClGf,KAAK,CAACG,KAAK,CAAC,CAACJ,WAAW,CACvB,GAAG,IAAI,CAACzC,SAAS,CAACW,OAAO,CAAC,CAC1B;;SAGF,IAAI7C,UAAU,CAAC4E,KAAK,CAACG,KAAK,CAAC,CAAC3F,OAAO,EAAE,CAAC,IAAI2F,KAAK,GAAG,CAAC,EACnD;WACCA,KAAK,EAAE;;;MAGT,CAAC;KAEF,MAAMe,yBAAyB,GAAI3E,IAAuB,IAAK;OAC9D,IAAI4E,IAAI,GAAG,KAAK;OAEhB,OAAO5E,IAAI,CACTQ,WAAW,EAAE,CACbqE,WAAW,CAAC,CAAC3D,GAA6B,EAAEpD,KAAwB,EAAEd,KAAa,KAAK;SACxF,IAAI,CAAC4H,IAAI,IAAI9G,KAAK,CAACG,OAAO,EAAE,KAAK,YAAY,EAC7C;WACCiD,GAAG,CAACC,IAAI,CAACnE,KAAK,CAAC;UACf,MACI,IAAI,CAAC4H,IAAI,IAAI9G,KAAK,CAACG,OAAO,EAAE,KAAK,MAAM,EAC5C;WACC2G,IAAI,GAAG,IAAI;;SAGZ,OAAO1D,GAAG;QACV,EAAE,EAAE,CAAC;MACP;KAEDhB,0BAAU,CAAC4E,UAAU,CAACpC,MAAM,CAAC,CAACqC,OAAO,CAAE/E,IAAuB,IAAK;OAClE,IAAIA,IAAI,CAAC/B,OAAO,EAAE,KAAK,GAAG,EAC1B;SACC,MAAM+G,sBAAqC,GAAGL,yBAAyB,CAAC3E,IAAI,CAAC;SAC7E,IAAIgF,sBAAsB,CAAC1H,MAAM,KAAK,CAAC,EACvC;WACC0C,IAAI,CAACiF,WAAW,CACfjF,IAAI,CAACQ,WAAW,EAAE,CAACwB,KAAK,CAAC,CAAC,EAAElF,UAAU,CAACkI,sBAAsB,EAAE,CAAC,CAAC,CAAC,CAClE;;SAGF,IAAIA,sBAAsB,CAAC1H,MAAM,GAAG,CAAC,IAAI,CAAC0H,sBAAsB,GAAG,CAAC,MAAM,CAAC,EAC3E;WACChF,IAAI,CAACiF,WAAW,CACfjF,IAAI,CAACQ,WAAW,EAAE,CAACwB,KAAK,CAAC,CAAC,EAAElF,UAAU,CAACkI,sBAAsB,EAAE,CAAC,CAAC,CAAC,CAClE;;;MAGH,CAAC;KAEFtC,MAAM,CAACxD,SAAS,CACf,IAAI,CAACS,SAAS,EAAE,EAChB,IAAI,CAACG,mBAAmB,EAAE,CAC1B;KAED,OAAO4C,MAAM;;CAEf;;;;;;;;"}