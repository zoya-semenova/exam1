this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t,n,r){"use strict";function s(e,n){if(!t.Type.isArray(e)){throw new TypeError("array is not a array")}if(!t.Type.isInteger(n)){throw new TypeError("index is not a integer")}const r=n<0?e.length+n:n;return e[r]}class i extends r.BBCodeScheme{getTagScheme(e){if(e==="code"){return new r.BBCodeTagScheme({name:"code",convertChild:(e,t)=>{if(["#linebreak","#tab","#text"].includes(e.getName())){return e}return t.createText(e.toString())}})}return new r.BBCodeTagScheme({name:"any"})}isAllowedTag(e){return true}isChildAllowed(e,t){return true}}const o=/\[(\/)?(\w+|\*)(.*?)]/gs;const c=e=>["\n","\t"].includes(e);const a=e=>["list","ul","ol"].includes(String(e).toLowerCase());const l=e=>["*","li"].includes(String(e).toLowerCase());const d=new i;class h{constructor(e={}){if(e.scheme){this.setScheme(e.scheme)}else{this.setScheme(new r.DefaultBBCodeScheme)}if(t.Type.isFunction(e.onUnknown)){this.setOnUnknown(e.onUnknown)}else{this.setOnUnknown(h.defaultOnUnknownHandler)}if(e.encoder instanceof n.BBCodeEncoder){this.setEncoder(e.encoder)}else{this.setEncoder(new n.BBCodeEncoder)}}setScheme(e){this.scheme=e}getScheme(){return this.scheme}setOnUnknown(e){if(!t.Type.isFunction(e)){throw new TypeError("handler is not a function")}this.onUnknownHandler=e}getOnUnknownHandler(){return this.onUnknownHandler}setEncoder(e){if(e instanceof n.BBCodeEncoder){this.encoder=e}else{throw new TypeError("encoder is not BBCodeEncoder instance")}}getEncoder(){return this.encoder}static defaultOnUnknownHandler(e,t){if(e.getType()===r.BBCodeNode.ELEMENT_NODE){const n=e.getName();if(["left","center","right","justify"].includes(n)){e.replace(t.createElement({name:"p",children:e.getChildren()}))}else if(["background","color","size"].includes(n)){e.replace(t.createElement({name:"b",children:e.getChildren()}))}else{const n=e.getOpeningTag();const r=e.getClosingTag();e.replace(t.createText(n),...e.getChildren(),t.createText(r))}}}static toLowerCase(e){if(t.Type.isStringFilled(e)){return e.toLowerCase()}return e}parseText(e){if(t.Type.isStringFilled(e)){return[...e].reduce(((e,n)=>{if(c(n)){e.push(n)}else{const r=s(e,-1);if(c(r)||t.Type.isNil(r)){e.push(n)}else{e[e.length-1]+=n}}return e}),[]).map((e=>{if(e==="\n"){return d.createNewLine()}if(e==="\t"){return d.createTab()}return d.createText({content:this.getEncoder().decodeText(e)})}))}return[]}static findNextTagIndex(e,t=0){const n=e.slice(t);const[r]=n.match(new RegExp(o))||[];if(r){return e.indexOf(r,t)}return-1}static trimQuotes(e){const t=String(e);if(/^["'].*["']$/g.test(t)){return t.slice(1,-1)}return e}parseAttributes(e){const n={value:"",attributes:[]};if(t.Type.isStringFilled(e)){if(e.startsWith("=")){n.value=this.getEncoder().decodeAttribute(h.trimQuotes(e.slice(1)));return n}return e.trim().split(" ").filter(Boolean).reduce(((e,t)=>{const[n,r=""]=t.split("=");e.attributes.push([h.toLowerCase(n),this.getEncoder().decodeAttribute(h.trimQuotes(r))]);return e}),n)}return n}parse(e){const t=d.createRoot();const n=h.findNextTagIndex(e);if(n!==0){const r=n===-1?e:e.slice(0,n);t.appendChild(...this.parseText(r))}const i=[t];const c=[];let u=null;let f=0;e.replace(o,((t,n,r,s,o)=>{const g=Boolean(n)===false;const p=t.length+o;const m=e.slice(p);const B=this.parseAttributes(s);const C=h.toLowerCase(r);let T=i[f];if(g){const n=!m.includes(`[/${r}]`);if(n&&!l(C)){const n=this.getScheme().getTagScheme(C);const r=n&&n.isVoid();if(r){u=d.createElement({name:C,value:B.value,attributes:Object.fromEntries(B.attributes)});u.setScheme(this.getScheme());T.appendChild(u)}else{T.appendChild(d.createText(t))}const s=h.findNextTagIndex(e,p);if(s!==0){const t=s===-1?m:e.slice(p,s);T.appendChild(...this.parseText(t))}}else{if(l(C)&&u&&l(u.getName())){f--;T=i[f]}u=d.createElement({name:C,value:B.value,attributes:Object.fromEntries(B.attributes)});const t=h.findNextTagIndex(e,p);if(t!==0){const n=t===-1?m:e.slice(p,t);u.appendChild(...this.parseText(n))}T.appendChild(u);f++;i[f]=u;c.push(C)}}else{if(c.includes(C)){f--;const e=c.indexOf(C);c.splice(e,1)}else{i[f].appendChild(d.createText(t))}if(a(C)&&f>0){f--}const n=h.findNextTagIndex(e,p);if(n!==0&&i[f]){const t=n===-1?m:e.slice(p,n);i[f].appendChild(...this.parseText(t))}if(l(i[f].getName())&&f>0){f--}}}));const g=e=>{let t=false;return e.getChildren().reduceRight(((e,n,r)=>{if(!t&&n.getName()==="#linebreak"){e.push(r)}else if(!t&&n.getName()!=="#tab"){t=true}return e}),[])};r.BBCodeNode.flattenAst(t).forEach((e=>{if(e.getName()==="*"){const t=g(e);if(t.length===1){e.setChildren(e.getChildren().slice(0,s(t,0)))}if(t.length>1&&(t&2)===0){e.setChildren(e.getChildren().slice(0,s(t,0)))}}}));t.setScheme(this.getScheme(),this.getOnUnknownHandler());return t}}e.BBCodeParser=h})(this.BX.UI.BBCode=this.BX.UI.BBCode||{},BX,BX.UI.BBCode,BX.UI.BBCode);
//# sourceMappingURL=parser.bundle.map.js